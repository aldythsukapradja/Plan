<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>InBody Tracker ‚Äî Bulletproof Dashboard</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
<!-- Chart.js v4 -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js" defer></script>

<style>
  :root{
    --bg:#0b0f14;
    --panel:#101621;
    --panel-2:#0e1420;
    --text:#e6f1ff;
    --muted:#9fb3c8;
    --border:rgba(255,255,255,0.08);
    --glow:0 0 0.75rem rgba(0,255,255,0.25);
    --cyan:#00e5ff;         /* weight / accent */
    --green:#21f3a3;        /* SMM / SMI */
    --purple:#a16bff;       /* PBF */
    --amber:#ffcf66;        /* BMR */
    --red:#ff6b6b;          /* visceral / obesity */
    --card-radius:16px;
    --shadow:0 6px 24px rgba(0,0,0,0.35), inset 0 0 0 1px var(--border);
    --sticky-h:68px;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
    background:
      radial-gradient(1200px 600px at 10% -10%, rgba(0,255,255,0.06), transparent 60%),
      radial-gradient(1200px 600px at 110% 10%, rgba(161,107,255,0.06), transparent 60%),
      linear-gradient(180deg, #0a0f15, #0b1118 20%, #0b0f14 60%);
    color:var(--text); line-height:1.4;
  }
  a{color:var(--cyan); text-decoration:none}
  .wrap{max-width:1100px; margin:0 auto; padding:calc(var(--sticky-h) + 16px) 16px 96px}

  /* Sticky header */
  header{
    position:fixed; inset:0 0 auto 0; height:var(--sticky-h);
    display:flex; align-items:center; justify-content:space-between;
    padding:12px 16px; backdrop-filter:blur(10px);
    background:rgba(10,16,24,0.6); border-bottom:1px solid var(--border); z-index:50;
  }
  .brand{
    display:flex; align-items:center; gap:12px;
  }
  .brand h1{margin:0; font-size:18px; letter-spacing:.4px}
  .last-scan{font-size:12px; color:var(--muted)}
  .debug{font-size:11px; color:#7bdcff}
  .controls{display:flex; align-items:center; gap:8px}
  select, button, .pill{
    background:var(--panel-2); color:var(--text); border:1px solid var(--border);
    padding:10px 12px; border-radius:999px; box-shadow:var(--shadow);
  }
  button{cursor:pointer}
  .hamburger{width:42px; height:42px; display:grid; place-items:center}
  .ham-bars{width:20px; height:14px; position:relative}
  .ham-bars span{position:absolute; left:0; right:0; height:2px; background:var(--text); border-radius:2px; box-shadow:var(--glow)}
  .ham-bars span:nth-child(1){top:0}
  .ham-bars span:nth-child(2){top:6px}
  .ham-bars span:nth-child(3){bottom:0}

  /* Overlay menu */
  .overlay{
    position:fixed; inset:0; background:rgba(6,10,16,0.92); backdrop-filter:blur(12px);
    display:none; z-index:80; padding:24px 16px;
  }
  .overlay.open{display:block}
  .overlay-inner{max-width:640px; margin:0 auto; text-align:center}
  .overlay h2{margin:10px 0 22px}
  .qlist{display:flex; flex-direction:column; gap:12px; align-items:center}
  .qlist a{
    display:block; width:min(420px, 90vw); text-align:center; padding:14px 18px; border-radius:999px;
    border:1px solid var(--border); background:linear-gradient(180deg,#0f1624,#0b1320);
    box-shadow:var(--shadow), 0 0 18px rgba(0,255,255,0.05);
  }
  .qlist a:hover{box-shadow:var(--shadow), 0 0 26px rgba(0,255,255,0.18)}

  /* Sections */
  section{scroll-margin-top:calc(var(--sticky-h) + 16px)}
  .section{background:linear-gradient(180deg,#0e1522,#0d1420); border:1px solid var(--border);
    border-radius:20px; padding:16px; margin:14px 0; box-shadow:var(--shadow)}
  .section h3{margin:0 0 10px; letter-spacing:.3px}
  .subtle{color:var(--muted)}

  /* KPIs grid */
  .kpis{display:grid; grid-template-columns:1fr; gap:12px}
  @media(min-width:700px){ .kpis{grid-template-columns:repeat(4,1fr)} }
  .kpi{
    background:linear-gradient(180deg,#10192a,#0f1829); border:1px solid var(--border); border-radius:var(--card-radius);
    padding:14px; box-shadow:var(--shadow); position:relative; overflow:hidden;
  }
  .kpi .name{font-size:12px; color:var(--muted); letter-spacing:.3px}
  .kpi .val{font-size:22px; font-weight:700}
  .delta{font-size:11px; padding:4px 8px; border-radius:999px; border:1px solid var(--border); margin-left:8px}
  .delta.good{background:rgba(33,243,163,0.1); color:var(--green)}
  .delta.bad{background:rgba(255,107,107,0.1); color:var(--red)}
  .mini{height:32px; margin-top:6px}
  .bar-track{height:8px; border-radius:6px; background:#0c1320; border:1px solid var(--border); overflow:hidden}
  .bar-fill{height:100%; width:0%; transition:width .6s ease}
  .spark{height:18px}

  /* Cards / panels */
  .card{background:linear-gradient(180deg,#0f1624,#0c1422); border:1px solid var(--border); border-radius:var(--card-radius); padding:12px; box-shadow:var(--shadow)}
  .row{display:grid; grid-template-columns:1fr; gap:12px}
  @media(min-width:900px){ .row{grid-template-columns:1fr 1fr} }

  /* Silhouettes (segmental) */
  .segs{display:grid; grid-template-columns:1fr; gap:12px}
  @media(min-width:900px){ .segs{grid-template-columns:1fr 1fr} }
  .sil{
    display:grid; grid-template-columns:90px 1fr; gap:12px; align-items:center
  }
  .human{
    width:90px; height:160px; border-radius:50px/90px; background:linear-gradient(180deg,#17243a,#0e1a2d);
    border:1px solid var(--border); position:relative; box-shadow:var(--shadow)
  }
  .human::before{content:""; position:absolute; width:32px; height:32px; border-radius:50%; top:-20px; left:50%; transform:translateX(-50%);
    background:linear-gradient(180deg,#17243a,#0e1a2d); border:1px solid var(--border)}
  .seg-bars{display:grid; gap:6px}
  .seg-row{display:flex; gap:8px; align-items:center; font-size:12px}
  .seg-name{width:28px; color:var(--muted)}
  .seg-track{flex:1; height:10px; border-radius:6px; border:1px solid var(--border); background:#0b1322; overflow:hidden}
  .seg-fill{height:100%; width:0%}

  /* Comparison */
  .toggle{display:flex; gap:8px; margin:8px 0 12px}
  .toggle button.active{outline:2px solid var(--cyan); box-shadow:var(--glow)}

  /* Details accordion */
  details{border:1px solid var(--border); border-radius:12px; padding:10px 12px; background:linear-gradient(180deg,#0f1624,#0c1524)}
  details[open]{box-shadow:var(--shadow)}
  details summary{cursor:pointer; list-style:none}
  details summary::-webkit-details-marker{display:none}

  /* Table */
  table{width:100%; border-collapse:collapse; font-size:12px}
  th,td{padding:8px; border-bottom:1px solid var(--border); vertical-align:top}
  th{text-align:left; color:var(--muted)}

  /* Up button */
  .up{
    position:fixed; right:16px; bottom:16px; display:none; z-index:70;
    padding:12px 14px; border-radius:999px; border:1px solid var(--border);
    background:linear-gradient(180deg,#0d1a28,#0a1624);
    box-shadow:var(--shadow), 0 0 18px rgba(0,229,255,0.25);
  }
  .up.show{display:block}

  /* Helper pills */
  .pill{display:inline-flex; gap:6px; align-items:center}
  .pill.cyan{box-shadow:0 0 24px rgba(0,229,255,0.25)}
  .pill.green{box-shadow:0 0 24px rgba(33,243,163,0.22)}
  .pill.purple{box-shadow:0 0 24px rgba(161,107,255,0.22)}
  .pill.amber{box-shadow:0 0 24px rgba(255,207,102,0.22)}
  .pill.red{box-shadow:0 0 24px rgba(255,107,107,0.22)}

  .muted{color:var(--muted)}
</style>
</head>
<body>
  <header>
    <div class="brand">
      <div class="pill cyan">üí° InBody Tracker</div>
      <div>
        <div class="last-scan">Last scan: <span id="lastScanTxt">‚Äî</span></div>
        <div class="debug" id="debugLine">Charts enabled ‚Ä¢ Forecast OLS+band</div>
      </div>
    </div>
    <div class="controls">
      <select id="scanSelect" aria-label="Select scan"></select>
      <button class="hamburger" id="openMenu" aria-label="Open quick links">
        <div class="ham-bars"><span></span><span></span><span></span></div>
      </button>
    </div>
  </header>

  <!-- Overlay Quick Links -->
  <div class="overlay" id="overlay">
    <div class="overlay-inner">
      <h2>Quick Links</h2>
      <div class="qlist">
        <a href="#kpis" data-link>KPIs</a>
        <a href="#comparison" data-link>Comparison</a>
        <a href="#insights" data-link>Insights</a>
        <a href="#composition" data-link>Composition</a>
        <a href="#metabolic" data-link>Metabolic</a>
        <a href="#segments" data-link>Segments</a>
        <a href="#forecast" data-link>Forecast</a>
        <a href="#mealplan" data-link>Meal Plan</a>
        <a href="#repo" data-link>Repository</a>
        <a href="#datasrc" data-link>Data Source</a>
      </div>
      <p class="subtle" style="margin-top:14px">Smooth scroll respects sticky header.</p>
      <p><button id="closeMenu">Close</button></p>
    </div>
  </div>

  <div class="wrap">
    <!-- KPIs -->
    <section id="kpis" class="section">
      <h3>Key Metrics</h3>
      <div class="kpis" id="kpiGrid"></div>
    </section>

    <!-- Comparison -->
    <section id="comparison" class="section">
      <h3>Changes Compared With <span id="cmpLabel" class="pill">Previous</span></h3>
      <div class="toggle">
        <button id="cmpPrev" class="pill active">Previous</button>
        <button id="cmpBase" class="pill">Baseline</button>
      </div>
      <div id="cmpCards" class="row"></div>
    </section>

    <!-- Insights -->
    <section id="insights" class="section">
      <h3>ü§ñ Overall & I-O-R</h3>
      <div class="row" id="insightsRow"></div>
    </section>

    <!-- Composition -->
    <section id="composition" class="section">
      <h3>Body Composition</h3>
      <div class="row">
        <div class="card">
          <div class="muted">Weight / SMM / Fat Mass</div>
          <canvas id="chartComp" height="220" aria-label="Composition chart"></canvas>
          <div class="muted" id="compFallback" style="display:none;">Chart unavailable</div>
        </div>
        <div class="card">
          <div class="muted">BMI vs PBF (Scatter)</div>
          <canvas id="chartScatter" height="220" aria-label="BMI vs PBF"></canvas>
          <div class="muted" id="scatterFallback" style="display:none;">Chart unavailable</div>
        </div>
      </div>
    </section>

    <!-- Metabolic -->
    <section id="metabolic" class="section">
      <h3>Metabolic</h3>
      <div class="row">
        <div class="card">
          <div class="muted">BMR (kcal) & Obesity Degree (%)</div>
          <canvas id="chartBmrOb" height="220" aria-label="BMR & Obesity"></canvas>
          <div class="muted" id="bmrFallback" style="display:none;">Chart unavailable</div>
        </div>
        <div class="card">
          <div class="muted">ECW/TBW</div>
          <canvas id="chartECW" height="220" aria-label="ECW/TBW"></canvas>
          <div class="muted" id="ecwFallback" style="display:none;">Chart unavailable</div>
        </div>
      </div>
    </section>

    <!-- Segments -->
    <section id="segments" class="section">
      <h3>Segmental Analysis</h3>
      <div class="segs">
        <div class="card sil">
          <div>
            <div class="pill green">Muscle</div>
            <div class="human" aria-hidden="true"></div>
          </div>
          <div class="seg-bars" id="segLean"></div>
        </div>
        <div class="card sil">
          <div>
            <div class="pill purple">Fat</div>
            <div class="human" aria-hidden="true"></div>
          </div>
          <div class="seg-bars" id="segFat"></div>
        </div>
      </div>
    </section>

    <!-- Forecast -->
    <section id="forecast" class="section">
      <h3>Forecast (OLS with Confidence Bands)</h3>
      <div class="row">
        <div class="card">
          <div class="pill cyan">Weight</div>
          <canvas id="fcWeight" height="220"></canvas>
          <div class="muted" id="fcWeightFallback" style="display:none;">Chart unavailable</div>
        </div>
        <div class="card">
          <div class="pill green">Skeletal Muscle Index (derived)</div>
          <canvas id="fcSMI" height="220"></canvas>
          <div class="muted" id="fcSMIFallback" style="display:none;">Chart unavailable</div>
        </div>
        <div class="card">
          <div class="pill purple">Percent Body Fat</div>
          <canvas id="fcPBF" height="220"></canvas>
          <div class="muted" id="fcPBFFallback" style="display:none;">Chart unavailable</div>
        </div>
      </div>
      <div class="card" style="margin-top:12px">
        <div class="muted">Milestones</div>
        <table id="milestonesTbl">
          <thead><tr><th>Point</th><th>Weight</th><th>SMI</th><th>PBF</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

    <!-- Meal Plan -->
    <section id="mealplan" class="section">
      <h3>Meal Plan</h3>
      <details>
        <summary>Daily kcal & macros ‚Ä¢ 7-day rotation ‚Ä¢ Grocery ‚Ä¢ Disclaimer</summary>
        <div class="row" style="margin-top:10px">
          <div class="card">
            <h4>Targets</h4>
            <ul class="muted">
              <li>Calories: <strong id="kcalTarget">~1700 kcal</strong></li>
              <li>Protein: <strong>1.6‚Äì2.0 g/kg</strong></li>
              <li>Carb timing: <strong>pre-workout</strong></li>
              <li>Fat: <strong>balance sat/mono/poly</strong></li>
            </ul>
          </div>
          <div class="card">
            <h4>7-Day Rotation</h4>
            <ol class="muted" id="rotationList">
              <li>Egg white omelet, chicken rice bowl, yogurt & berries</li>
              <li>Greek salad + tuna, beef & veg, protein shake</li>
              <li>Overnight oats, salmon, cottage cheese & fruit</li>
              <li>Tofu stir-fry, chicken wrap, kefir</li>
              <li>Lentil soup, steak & greens, casein</li>
              <li>Protein pancakes, turkey bowl, almonds</li>
              <li>Free choice (hit protein & calories)</li>
            </ol>
          </div>
        </div>
        <div class="card" style="margin-top:10px">
          <h4>Grocery List</h4>
          <p class="muted">Lean proteins (chicken, fish, yogurt), whole grains, leafy greens, berries, nuts, olive oil, electrolyte tabs.</p>
          <h4>Disclaimer</h4>
          <p class="muted">Informational only. Adjust per medical guidance and tolerance.</p>
        </div>
      </details>
    </section>

    <!-- Repository -->
    <section id="repo" class="section">
      <h3>Repository</h3>
      <details open>
        <summary>Master table (metrics + 7 IOR columns)</summary>
        <div style="overflow:auto; margin-top:10px">
          <table id="repoTbl"></table>
        </div>
      </details>
    </section>

    <!-- Data Source -->
    <section id="datasrc" class="section">
      <h3>Data Source</h3>
      <p class="muted">Source: Self-reported + InBody scans ‚Ä¢ Records: <span id="recCount">0</span> ‚Ä¢ Notes: ‚ÄúCharts enabled‚Äù.</p>
      <details>
        <summary>Raw JSON (dataset)</summary>
        <pre id="rawJson" style="white-space:pre-wrap; color:#b7c9e6; font-size:12px;"></pre>
      </details>
    </section>
  </div>

  <button class="up" id="toTop">‚Üë Up</button>

<script>
/* -------------------- Embedded Dataset -------------------- */
const DATA = {
  "scans": [
    {
      "date": "2025-03-01",
      "label": "Mar 2025 (est.)",
      "metrics": {"weight":90.0,"pbf":42.0,"bmi":31.9,"score":62,"visceral":15,"smm":32.0,"fat":38.0,"bmr":1750,"tbw":42.5,"protein":11.2,"minerals":3.8,"ffm":52.0,"obesity":145.0,"ecwtbw":0.390},
      "segments_lean": {"la":{"kg":3.00,"pct":98.0},"ra":{"kg":3.10,"pct":98.5},"tr":{"kg":21.0,"pct":99.0},"ll":{"kg":9.40,"pct":97.5},"rl":{"kg":9.50,"pct":98.0}},
      "segments_fat":  {"la":{"kg":3.04,"pct":8.0},"ra":{"kg":3.04,"pct":8.0},"tr":{"kg":19.0,"pct":50.0},"ll":{"kg":6.46,"pct":17.0},"rl":{"kg":6.46,"pct":17.0}},
      "ior": {"composition":{"insight":"Fat dominant","observation":"High fat, lower muscle relative","recommendation":"Deficit >= 300; protein >= 1.6 g/kg"},"bmi_pbf":{"insight":"BMI and PBF high","observation":"BMI 31.9, PBF 42%","recommendation":"Add waist/hip tracking"},"bmr_obesity":{"insight":"BMR high due to mass","observation":"1750 kcal baseline","recommendation":"Moderate deficit 300-500"},"ecwtbw":{"insight":"Hydration high side","observation":"ECW/TBW 0.390","recommendation":"Control sodium"},"segmental_lean":{"insight":"Balanced limbs, trunk heavy","observation":"~97-99% of standard","recommendation":"Balanced training"},"segmental_fat":{"insight":"Central fat heavy","observation":"Trunk 50% share","recommendation":"Prioritize trunk fat loss"},"overall":{"insight":"Obese baseline","observation":"VF 15, obesity 145%","recommendation":"Initiate fat-loss"}}
    },
    {
      "date": "2025-04-15",
      "label": "Mid-Apr 2025 (est.)",
      "metrics": {"weight":84.7,"pbf":39.6,"bmi":30.0,"score":63,"visceral":14,"smm":31.2,"fat":33.5,"bmr":1700,"tbw":41.0,"protein":10.9,"minerals":3.7,"ffm":51.2,"obesity":139.0,"ecwtbw":0.389},
      "segments_lean": {"la":{"kg":2.90,"pct":97.8},"ra":{"kg":3.00,"pct":98.2},"tr":{"kg":20.5,"pct":98.5},"ll":{"kg":9.20,"pct":97.2},"rl":{"kg":9.30,"pct":97.6}},
      "segments_fat":  {"la":{"kg":2.68,"pct":8.0},"ra":{"kg":2.68,"pct":8.0},"tr":{"kg":16.75,"pct":50.0},"ll":{"kg":5.70,"pct":17.0},"rl":{"kg":5.70,"pct":17.0}},
      "ior": {"composition":{"insight":"Early fat drop","observation":"~5 kg fat loss","recommendation":"Add resistance training"},"bmi_pbf":{"insight":"PBF down faster than BMI","observation":"PBF 39.6%, BMI 30.0","recommendation":"Loss <= 0.7% BW/week"},"bmr_obesity":{"insight":"BMR slightly down","observation":"1700 kcal","recommendation":"Avoid aggressive cuts"},"ecwtbw":{"insight":"Hydration stable","observation":"0.389","recommendation":"35-40 ml/kg"},"segmental_lean":{"insight":"Balanced limbs","observation":"Arms 98%, legs 97%","recommendation":"Add squats/deadlifts"},"segmental_fat":{"insight":"Fat down modest","observation":"VF down 1","recommendation":"2-3 cardio/week"},"overall":{"insight":"Good start","observation":"-5.3 kg total","recommendation":"Sustain momentum"}}
    },
    {
      "date": "2025-06-13",
      "label": "13 Jun 2025 (scan)",
      "metrics": {"weight":80.6,"pbf":32.6,"bmi":28.6,"score":65,"visceral":12,"smm":30.4,"fat":26.2,"bmr":1544,"tbw":39.9,"protein":10.7,"minerals":3.75,"ffm":54.4,"obesity":130.0,"ecwtbw":0.388},
      "segments_lean": {"la":{"kg":3.05,"pct":95.7},"ra":{"kg":3.12,"pct":97.9},"tr":{"kg":24.8,"pct":97.6},"ll":{"kg":8.09,"pct":91.3},"rl":{"kg":8.16,"pct":92.0}},
      "segments_fat":  {"la":{"kg":1.90,"pct":333.8},"ra":{"kg":1.90,"pct":323.6},"tr":{"kg":14.10,"pct":358.4},"ll":{"kg":3.50,"pct":223.9},"rl":{"kg":3.60,"pct":225.8}},
      "ior": {"composition":{"insight":"Strong fat loss","observation":"Fat -11.8, SMM -1.6","recommendation":"Keep deficit; carbs pre-workout"},"bmi_pbf":{"insight":"PBF dropping faster","observation":"BMI 28.6, PBF 32.6%","recommendation":"Use tape and photos"},"bmr_obesity":{"insight":"BMR stable","observation":"1544 kcal","recommendation":"Deficit 300-500 kcal"},"ecwtbw":{"insight":"Hydration healthy","observation":"0.388","recommendation":"Maintain electrolytes"},"segmental_lean":{"insight":"Legs weak","observation":"LL 91%, RL 92%","recommendation":"Unilateral work"},"segmental_fat":{"insight":"Central fat high","observation":"Trunk 14.1 kg (358%)","recommendation":"Aerobic + core stability"},"overall":{"insight":"Overfat improving","observation":"VF 12","recommendation":"Push to VF < 10"}}
    },
    {
      "date": "2025-09-11",
      "label": "11 Sep 2025 (scan)",
      "metrics": {"weight":79.0,"pbf":31.3,"bmi":28.0,"score":66,"visceral":10,"smm":30.4,"fat":24.8,"bmr":1542,"tbw":39.8,"protein":10.6,"minerals":3.75,"ffm":54.2,"obesity":127.9,"ecwtbw":0.388},
      "segments_lean": {"la":{"kg":3.00,"pct":94.6},"ra":{"kg":3.03,"pct":95.6},"tr":{"kg":24.4,"pct":96.6},"ll":{"kg":8.15,"pct":92.6},"rl":{"kg":8.19,"pct":92.9}},
      "segments_fat":  {"la":{"kg":1.70,"pct":303.4},"ra":{"kg":1.70,"pct":298.3},"tr":{"kg":13.20,"pct":334.8},"ll":{"kg":3.50,"pct":217.6},"rl":{"kg":3.50,"pct":218.5}},
      "ior": {"composition":{"insight":"Progress steady","observation":"Muscle stable, fat down","recommendation":"Lift 2-3x/week"},"bmi_pbf":{"insight":"PBF steady drop","observation":"BMI 28.0, PBF 31.3%","recommendation":"~0.5% BW loss/week"},"bmr_obesity":{"insight":"BMR stable","observation":"1542 kcal","recommendation":"Avoid further drop"},"ecwtbw":{"insight":"Hydration steady","observation":"0.388","recommendation":"~3 L/day"},"segmental_lean":{"insight":"Arms/trunk solid, legs lag","observation":"Legs ~92%","recommendation":"Leg hypertrophy focus"},"segmental_fat":{"insight":"Central fat dropping","observation":"VF 10","recommendation":"Add HIIT block"},"overall":{"insight":"Near overweight","observation":"VF 10","recommendation":"Push to VF <= 9"}}
    },
    {
      "date": "2025-09-24",
      "label": "24 Sep 2025 (scan)",
      "metrics": {"weight":76.8,"pbf":29.7,"bmi":27.2,"score":68,"visceral":9,"smm":30.2,"fat":22.8,"bmr":1536,"tbw":39.6,"protein":10.6,"minerals":3.75,"ffm":54.0,"obesity":124.8,"ecwtbw":0.387},
      "segments_lean": {"la":{"kg":3.01,"pct":96.6},"ra":{"kg":3.08,"pct":98.2},"tr":{"kg":24.4,"pct":97.4},"ll":{"kg":7.87,"pct":90.9},"rl":{"kg":7.94,"pct":90.9}},
      "segments_fat":  {"la":{"kg":1.50,"pct":274.2},"ra":{"kg":1.50,"pct":271.7},"tr":{"kg":12.30,"pct":314.1},"ll":{"kg":3.10,"pct":192.5},"rl":{"kg":3.10,"pct":194.0}},
      "ior": {"composition":{"insight":"Milestone","observation":"Fat -15.2, muscle stable","recommendation":"Start recomposition"},"bmi_pbf":{"insight":"BMI vs PBF gap","observation":"BMI 27.2, PBF 29.7%","recommendation":"Aim PBF <= 25%"},"bmr_obesity":{"insight":"BMR stable","observation":"1536 kcal","recommendation":"Preserve strength"},"ecwtbw":{"insight":"Hydration optimal","observation":"0.387","recommendation":"Maintain intake"},"segmental_lean":{"insight":"Legs lag","observation":"~91%","recommendation":"Lower-body overload"},"segmental_fat":{"insight":"Abdominal fat down","observation":"VF 9","recommendation":"Transition to recomp + diet breaks"},"overall":{"insight":"Obese to overweight","observation":"-13.2 kg; ~85% fat loss; VF 9","recommendation":"Next: 72 kg, PBF <= 25%, VF <= 7"}}
    }
  ]
};

/* -------------------- Utilities -------------------- */
const fmt = (v, d=1) => (typeof v === 'number' ? v.toFixed(d) : v);
const el = (sel) => document.querySelector(sel);
const make = (tag, cls) => { const n = document.createElement(tag); if (cls) n.className = cls; return n; };
const COLORS = { weight:'var(--cyan)', smm:'var(--green)', pbf:'var(--purple)', bmr:'var(--amber)', obesity:'var(--red)', fat:'var(--purple)' };

/* Simple OLS regression with band; enforces negative slope if observed slope < 0 */
function olsForecast(xs, ys, futureCount=12){
  // xs, ys = numeric arrays; xs in days since first
  const n = xs.length;
  const xbar = xs.reduce((a,b)=>a+b,0)/n;
  const ybar = ys.reduce((a,b)=>a+b,0)/n;
  let num=0, den=0;
  for(let i=0;i<n;i++){ num += (xs[i]-xbar)*(ys[i]-ybar); den += (xs[i]-xbar)**2; }
  let slope = den ? num/den : 0;
  const intercept = ybar - slope*xbar;

  // residual std
  let resid = [];
  for(let i=0;i<n;i++){ resid.push(ys[i] - (intercept + slope*xs[i])); }
  const sigma = Math.sqrt(resid.reduce((a,b)=>a+b*b,0) / Math.max(1, n-2));

  // If slope is negative, enforce strictly decreasing continuation
  const lastX = xs[xs.length-1];
  const lastY = ys[ys.length-1];

  let fxs = [], fys = [], upper=[], lower=[];
  for(let i=1;i<=futureCount;i++){
    const x = lastX + i*7; // weekly steps for projection
    let y = intercept + slope*x;
    if (slope < 0) {
      // ensure monotonic decrease
      y = Math.min(y, fxs.length ? fys[fys.length-1]-Math.abs(slope)*7 : lastY - Math.abs(slope)*7);
    }
    fxs.push(x); fys.push(y);
    upper.push(y + sigma); lower.push(y - sigma);
  }
  return {fxs, fys, upper, lower, slope, intercept, sigma};
}

/* Derived SMI (simple proxy): SMM / (height^2). If height unknown, scale to index-like score. */
const HEIGHT_M = 1.74; // assumption for index derivation
function deriveSMI(smm){ return smm / (HEIGHT_M*HEIGHT_M); }

/* Smooth scroll with sticky header offset */
function scrollToId(id){
  const target = document.getElementById(id);
  if(!target) return;
  const y = target.getBoundingClientRect().top + window.scrollY - (parseInt(getComputedStyle(document.documentElement).getPropertyValue('--sticky-h')) + 8);
  window.scrollTo({top:y, behavior:'smooth'});
}

/* -------------------- Build Header / Overlay -------------------- */
(function initHeader(){
  const sel = el('#scanSelect');
  // populate scans; default to last
  DATA.scans.forEach((s, i)=>{
    const opt = make('option');
    opt.value = i; opt.textContent = `${s.label} ‚Äî ${s.date}`;
    sel.appendChild(opt);
  });
  sel.value = (DATA.scans.length-1).toString();
  el('#lastScanTxt').textContent = `${DATA.scans[DATA.scans.length-1].label} (${DATA.scans[DATA.scans.length-1].date})`;
  el('#recCount').textContent = DATA.scans.length.toString();
  el('#rawJson').textContent = JSON.stringify(DATA, null, 2);

  const overlay = el('#overlay');
  el('#openMenu').onclick = ()=> overlay.classList.add('open');
  el('#closeMenu').onclick = ()=> overlay.classList.remove('open');
  overlay.querySelectorAll('[data-link]').forEach(a=>{
    a.addEventListener('click', (e)=>{
      e.preventDefault();
      overlay.classList.remove('open');
      const id = a.getAttribute('href').replace('#','');
      setTimeout(()=>scrollToId(id), 60);
    });
  });

  // Up button
  const up = el('#toTop');
  window.addEventListener('scroll', ()=>{
    if (window.scrollY > 400) up.classList.add('show'); else up.classList.remove('show');
  });
  up.onclick = ()=> window.scrollTo({top:0, behavior:'smooth'});
})();

/* -------------------- KPIs -------------------- */
const KPI_LIST = [
  {key:'weight', name:'Weight', unit:'kg', color:'var(--cyan)', good:'down'},
  {key:'smm', name:'SMM', unit:'kg', color:'var(--green)', good:'up'},
  {key:'pbf', name:'PBF', unit:'%', color:'var(--purple)', good:'down'},
  {key:'obesity', name:'Obesity Degree', unit:'%', color:'var(--red)', good:'down'},
  {key:'visceral', name:'Visceral Fat', unit:'', color:'var(--red)', good:'down'},
  {key:'bmr', name:'BMR', unit:'kcal', color:'var(--amber)', good:'flatUp'},
  {key:'score', name:'InBody Score', unit:'', color:'var(--cyan)', good:'up'},
  {key:'deficit', name:'Calorie Deficit Target', unit:'kcal', color:'var(--amber)', derived:true}
];

function getMetricSeries(key){
  return DATA.scans.map(s => key==='deficit' ? 500 : (s.metrics[key]));
}

function buildKPIs(idx){
  const grid = el('#kpiGrid'); grid.innerHTML='';
  const curr = DATA.scans[idx].metrics;
  const prev = DATA.scans[Math.max(0, idx-1)].metrics;
  KPI_LIST.forEach(k=>{
    const card = make('div','kpi');
    const n = make('div','name'); n.textContent = k.name; card.appendChild(n);

    const v = (k.derived ? 500 : curr[k.key]);
    const u = k.unit;
    const val = make('div','val'); val.innerHTML = `${fmt(v, k.key==='pbf'||k.key==='obesity'||k.key==='ecwtbw'?1:1)} <span class="muted">${u}</span>`;
    const delta = (k.derived ? 0 : (v - prev[k.key]));
    const good = (k.good==='down' && delta<0) || (k.good==='up' && delta>0) || (k.good==='flatUp' && delta>=0);
    const dspan = make('span','delta '+(good?'good':'bad'));
    dspan.textContent = (delta>=0?'+':'') + fmt(delta, 1) + (u?(' '+u):'');
    val.appendChild(dspan);
    card.appendChild(val);

    // mini bar "gauge"
    const mini = make('div','mini');
    const track = make('div','bar-track');
    const fill = make('div','bar-fill');
    fill.style.background = k.color;
    const series = getMetricSeries(k.key);
    const min = Math.min(...series); const max = Math.max(...series);
    const pct = max>min ? ((v - min)/(max - min))*100 : 100;
    fill.style.width = pct + '%';
    track.appendChild(fill); mini.appendChild(track); card.appendChild(mini);

    // small sparkline (CSS canvas via Chart.js if available)
    const spark = make('canvas','spark'); card.appendChild(spark);
    grid.appendChild(card);

    if (window.Chart){
      const ctx = spark.getContext('2d');
      new Chart(ctx,{
        type:'line',
        data:{ labels: series.map((_,i)=>i+1), datasets:[{
          data: series, borderColor:k.color, borderWidth:1.5, pointRadius:0, tension:.35,
          fill:false
        }]},
        options:{ responsive:true, maintainAspectRatio:false, plugins:{legend:{display:false},tooltip:{enabled:false}}, scales:{x:{display:false}, y:{display:false}}}
      });
    }
  });
}

/* -------------------- Comparison -------------------- */
let compareTo = 'previous'; // or 'baseline'
function buildComparison(idx){
  el('#cmpLabel').textContent = compareTo==='previous' ? 'Previous' : 'Baseline';
  const baseIdx = compareTo==='previous' ? Math.max(0, idx-1) : 0;
  const wrap = el('#cmpCards'); wrap.innerHTML='';
  const curr = DATA.scans[idx].metrics;
  const base = DATA.scans[baseIdx].metrics;
  ['weight','smm','pbf','visceral','bmr','obesity','score','fat'].forEach(k=>{
    const c = make('div','card');
    c.innerHTML = `<div class="muted">${k.toUpperCase()}</div>
      <div style="font-size:18px; font-weight:700">${fmt(curr[k],1)} <span class="muted">${k==='bmr'?'kcal':(k==='pbf'||k==='obesity'?'%':'')}</span>
      <span class="delta ${curr[k]-base[k] < 0 ? 'good':'bad'}">${(curr[k]-base[k] >=0?'+':'')+fmt(curr[k]-base[k],1)}</span></div>`;
    wrap.appendChild(c);
  });
}

/* -------------------- Insights (Overall + I-O-R) -------------------- */
function buildInsights(idx){
  const row = el('#insightsRow'); row.innerHTML='';
  const s = DATA.scans[idx];
  const order = ['overall','composition','bmi_pbf','bmr_obesity','ecwtbw','segmental_lean','segmental_fat'];
  order.forEach(key=>{
    const ior = s.ior[key];
    const card = make('div','card');
    card.innerHTML = `<div class="pill">ü§ñ ${key.replace('_','/').toUpperCase()}</div>
      <div style="margin-top:6px"><strong>${ior.insight}</strong></div>
      <div class="muted">${ior.observation}</div>
      <div class="muted"><em>${ior.recommendation}</em></div>`;
    row.appendChild(card);
  });
}

/* -------------------- Charts -------------------- */
let charts = {};
function destroyCharts(){
  if (!window.Chart) return;
  Object.values(charts).forEach(ch=>{ try{ ch.destroy(); }catch(e){} });
  charts = {};
}

/* Helpers: labels and series */
function getLabels(){ return DATA.scans.map(s=>s.label); }
function seriesOf(key){ return DATA.scans.map(s=>s.metrics[key]); }
function seriesBMI(){ return DATA.scans.map(s=>({x:s.metrics.bmi, y:s.metrics.pbf})); }
function seriesECW(){ return DATA.scans.map(s=>s.metrics.ecwtbw); }

/* Build all charts (guarded) */
function buildCharts(){
  const hasChart = !!window.Chart;
  const toggle = (id, showChart)=>{ el('#'+id).style.display = showChart?'block':'none'; el('#'+id+'Fallback').style.display = showChart?'none':'block'; };

  // Composition
  toggle('chartComp', hasChart);
  toggle('chartScatter', hasChart);
  toggle('chartBmrOb', hasChart);
  toggle('chartECW', hasChart);
  toggle('fcWeight', hasChart);
  toggle('fcSMI', hasChart);
  toggle('fcPBF', hasChart);
  if (!hasChart) return;

  const labels = getLabels();
  const ctxComp = el('#chartComp').getContext('2d');
  charts.comp = new Chart(ctxComp, {
    type:'line',
    data:{ labels, datasets:[
      {label:'Weight', data: seriesOf('weight'), borderColor:COLORS.weight, tension:.35, pointRadius:3},
      {label:'SMM', data: seriesOf('smm'), borderColor:COLORS.smm, tension:.35, pointRadius:3},
      {label:'Fat Mass', data: seriesOf('fat'), borderColor:COLORS.fat, borderDash:[4,3], tension:.35, pointRadius:3}
    ]},
    options:{ plugins:{legend:{position:'bottom'}}, scales:{x:{grid:{color:'rgba(255,255,255,0.06)'}}, y:{grid:{color:'rgba(255,255,255,0.06)'}}} }
  });

  const ctxSc = el('#chartScatter').getContext('2d');
  charts.scat = new Chart(ctxSc, {
    type:'scatter',
    data:{ datasets:[{label:'BMI vs PBF', data: seriesBMI(), borderColor:COLORS.pbf, backgroundColor:'rgba(161,107,255,0.25)'}] },
    options:{ plugins:{legend:{display:false}}, scales:{x:{title:{text:'BMI', display:true}}, y:{title:{text:'PBF %', display:true}}} }
  });

  const ctxBO = el('#chartBmrOb').getContext('2d');
  charts.bmr = new Chart(ctxBO, {
    type:'line',
    data:{ labels, datasets:[
      {label:'BMR (kcal)', data: seriesOf('bmr'), borderColor:COLORS.bmr, yAxisID:'y', tension:.35},
      {label:'Obesity Degree (%)', data: seriesOf('obesity'), borderColor:COLORS.obesity, yAxisID:'y1', tension:.35}
    ]},
    options:{ plugins:{legend:{position:'bottom'}}, scales:{y:{position:'left', grid:{color:'rgba(255,255,255,0.06)'}}, y1:{position:'right', grid:{drawOnChartArea:false}}} }
  });

  const ctxECW = el('#chartECW').getContext('2d');
  charts.ecw = new Chart(ctxECW, {
    type:'line',
    data:{ labels, datasets:[{label:'ECW/TBW', data: seriesECW(), borderColor:'#7bdcff', tension:.35}] },
    options:{ plugins:{legend:{position:'bottom'}}, scales:{y:{suggestedMin:0.36, suggestedMax:0.40}} }
  });

  // Forecasts
  buildForecastCharts();
}

/* Forecast builders */
function buildForecastCharts(){
  const labels = getLabels();
  // map dates to numeric x (days since first)
  const dates = DATA.scans.map(s => new Date(s.date));
  const day0 = dates[0].getTime();
  const xs = dates.map(d => (d.getTime()-day0)/(1000*60*60*24));

  // Weight
  makeForecastChart('fcWeight', seriesOf('weight'), xs, 'kg', COLORS.weight, 12, v=>v);

  // SMI (from smm)
  const smiHist = seriesOf('smm').map(v => deriveSMI(v));
  makeForecastChart('fcSMI', smiHist, xs, '', COLORS.smm, 12, v=>v);

  // PBF with clamp [8,60]
  makeForecastChart('fcPBF', seriesOf('pbf'), xs, '%', COLORS.pbf, 12, v=>Math.min(60, Math.max(8, v)));
}

function makeForecastChart(canvasId, hist, xs, unit, color, weeks, clampFn){
  const ctx = el('#'+canvasId)?.getContext('2d'); if (!ctx) return;
  const {fxs, fys, upper, lower, slope, sigma} = olsForecast(xs, hist, weeks);
  const labels = [...hist.map((_,i)=>`H${i+1}`), ...fys.map((_,i)=>`+${(i+1)}w`)];
  const histData = hist.map(v => clampFn(v));
  const fData = fys.map(v => clampFn(v));
  const upData = upper.map(v => clampFn(v));
  const loData = lower.map(v => clampFn(v));

  // band fill between upper and lower
  charts[canvasId] = new Chart(ctx, {
    type:'line',
    data:{ labels, datasets:[
      {label:'History', data: histData, borderColor:color, pointRadius:2, tension:.35},
      {label:'Forecast Upper', data:[...Array(hist.length).fill(null), ...upData], borderColor:'rgba(0,0,0,0)', pointRadius:0},
      {label:'Forecast Lower', data:[...Array(hist.length).fill(null), ...loData], borderColor:'rgba(0,0,0,0)', pointRadius:0, fill:'-1', backgroundColor:'rgba(0, 229, 255, 0.10)'},
      {label:'Forecast', data:[...Array(hist.length).fill(null), ...fData], borderColor:color, borderDash:[5,3], pointRadius:2, tension:.35}
    ]},
    options:{ plugins:{legend:{position:'bottom'}, tooltip:{ callbacks:{ label:(ctx)=> `${fmt(ctx.parsed.y,1)} ${unit}` } }}, scales:{x:{}, y:{}} }
  });

  // Milestones table (Today, +2w, +4w, +12w)
  if (canvasId === 'fcPBF'){ // compute once after all
    buildMilestones(fData, smiHist=null, histData, unit);
  }
}

function buildMilestones(weightF, smiHist, pbfHist, unit){
  // We rebuild for Weight, SMI, PBF after all charts exist, so pull from charts directly
  const w = charts.fcWeight?.data?.datasets?.[3]?.data.filter(x=>x!=null) || [];
  const s = charts.fcSMI?.data?.datasets?.[3]?.data.filter(x=>x!=null) || [];
  const p = charts.fcPBF?.data?.datasets?.[3]?.data.filter(x=>x!=null) || [];
  const todayW = DATA.scans[DATA.scans.length-1].metrics.weight;
  const todaySMI = deriveSMI(DATA.scans[DATA.scans.length-1].metrics.smm);
  const todayPBF = DATA.scans[DATA.scans.length-1].metrics.pbf;

  function at(weeks){ return {
      W: weeks===0 ? todayW : (w[weeks-1] ?? w[w.length-1]),
      S: weeks===0 ? todaySMI: (s[weeks-1] ?? s[s.length-1]),
      P: weeks===0 ? todayPBF: (p[weeks-1] ?? p[p.length-1]),
  };}

  const rows = [
    ['Today', at(0)],
    ['+2w',   at(2)],
    ['+4w',   at(4)],
    ['+12w',  at(12)]
  ];
  const tbody = el('#milestonesTbl tbody'); tbody.innerHTML='';
  rows.forEach(r=>{
    const tr = make('tr');
    tr.innerHTML = `<td>${r[0]}</td><td>${fmt(r[1].W,1)} kg</td><td>${fmt(r[1].S,2)}</td><td>${fmt(r[1].P,1)} %</td>`;
    tbody.appendChild(tr);
  });
}

/* -------------------- Segmental bars -------------------- */
const SEG_KEYS = [['la','LA'],['ra','RA'],['tr','TR'],['ll','LL'],['rl','RL']];
function buildSegments(idx){
  const s = DATA.scans[idx];
  const lean = s.segments_lean, fat = s.segments_fat;

  const leanWrap = el('#segLean'); leanWrap.innerHTML='';
  const fatWrap = el('#segFat'); fatWrap.innerHTML='';

  SEG_KEYS.forEach(([k, label])=>{
    const rowL = make('div','seg-row');
    rowL.innerHTML = `<span class="seg-name">${label}</span><div class="seg-track"><div class="seg-fill" style="background:var(--green); width:${Math.min(100, lean[k].pct)}%"></div></div><span class="muted">${fmt(lean[k].kg,2)} kg | ${fmt(lean[k].pct,1)}%</span>`;
    leanWrap.appendChild(rowL);

    const rowF = make('div','seg-row');
    // Normalize fat % visualization (cap to 100 for bar display but keep numbers)
    const barPct = Math.min(100, fat[k].pct);
    rowF.innerHTML = `<span class="seg-name">${label}</span><div class="seg-track"><div class="seg-fill" style="background:var(--purple); width:${barPct}%"></div></div><span class="muted">${fmt(fat[k].kg,2)} kg | ${fmt(fat[k].pct,1)}%</span>`;
    fatWrap.appendChild(rowF);
  });
}

/* -------------------- Repository Table (metrics + 7 IOR columns) -------------------- */
function buildRepo(){
  const tbl = el('#repoTbl'); tbl.innerHTML='';
  const head = make('thead'); const htr = make('tr');
  const cols = [
    'date','label','weight','smm','fat','pbf','bmi','bmr','score','visceral','tbw','protein','minerals','ffm','obesity','ecwtbw',
    'ior_composition','ior_bmi_pbf','ior_bmr_obesity','ior_ecwtbw','ior_segmental_lean','ior_segmental_fat','ior_overall'
  ];
  cols.forEach(c=>{ const th=make('th'); th.textContent=c; htr.appendChild(th); }); head.appendChild(htr); tbl.appendChild(head);
  const body = make('tbody');
  DATA.scans.forEach(s=>{
    const tr = make('tr');
    const m = s.metrics;
    const i = s.ior;
    const map = {
      date:s.date, label:s.label, weight:m.weight, smm:m.smm, fat:m.fat, pbf:m.pbf, bmi:m.bmi, bmr:m.bmr, score:m.score, visceral:m.visceral,
      tbw:m.tbw, protein:m.protein, minerals:m.minerals, ffm:m.ffm, obesity:m.obesity, ecwtbw:m.ecwtbw,
      ior_composition: `${i.composition.insight} ‚Äî ${i.composition.observation}`,
      ior_bmi_pbf: `${i.bmi_pbf.insight} ‚Äî ${i.bmi_pbf.observation}`,
      ior_bmr_obesity: `${i.bmr_obesity.insight} ‚Äî ${i.bmr_obesity.observation}`,
      ior_ecwtbw: `${i.ecwtbw.insight} ‚Äî ${i.ecwtbw.observation}`,
      ior_segmental_lean: `${i.segmental_lean.insight} ‚Äî ${i.segmental_lean.observation}`,
      ior_segmental_fat: `${i.segmental_fat.insight} ‚Äî ${i.segmental_fat.observation}`,
      ior_overall: `${i.overall.insight} ‚Äî ${i.overall.observation}`
    };
    cols.forEach(c=>{ const td=make('td'); td.textContent = map[c]; tr.appendChild(td); });
    body.appendChild(tr);
  });
  tbl.appendChild(body);
}

/* -------------------- Scan Change Handling -------------------- */
function refreshAll(){
  const idx = parseInt(el('#scanSelect').value,10);
  el('#lastScanTxt').textContent = `${DATA.scans[idx].label} (${DATA.scans[idx].date})`;
  destroyCharts();
  buildKPIs(idx);
  buildComparison(idx);
  buildInsights(idx);
  buildCharts();
  buildSegments(idx);
}
el('#scanSelect').addEventListener('change', refreshAll);

/* Comparison toggle */
el('#cmpPrev').onclick = ()=>{ compareTo='previous'; el('#cmpPrev').classList.add('active'); el('#cmpBase').classList.remove('active'); refreshAll(); };
el('#cmpBase').onclick = ()=>{ compareTo='baseline'; el('#cmpBase').classList.add('active'); el('#cmpPrev').classList.remove('active'); refreshAll(); };

/* -------------------- Init -------------------- */
document.addEventListener('DOMContentLoaded', ()=>{
  refreshAll();
});
</script>
</body>
</html>