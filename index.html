<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
<title>InBody Tracker</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap" rel="stylesheet">
<style>
:root{
  --bg:#0b0f17; --panel:#0c1322; --panel-2:#0c1526; --text:#e5e7eb; --muted:#9ca3af;
  --border:rgba(255,255,255,0.08);
  --cyan:#22d3ee; --purple:#a78bfa; --amber:#f59e0b; --green:#34d399; --red:#f87171;
  --radius:16px; --shadow:0 10px 30px rgba(0,0,0,.35), 0 0 0 1px var(--border) inset;
}
*{box-sizing:border-box}
html{height:100%;-webkit-text-size-adjust:100%}
body{
  min-height:100%;margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,Helvetica,sans-serif;
  color:var(--text);
  background:
    radial-gradient(1100px 500px at 75% -10%, rgba(167,139,250,.12), transparent 60%),
    radial-gradient(900px 450px at -10% 5%, rgba(34,211,238,.08), transparent 55%),
    linear-gradient(#0b0f17,#0b0f17);
  padding-top:env(safe-area-inset-top); padding-bottom:max(12px,env(safe-area-inset-bottom));
}
.container{max-width:1120px;margin:0 auto;padding:12px 10px 72px}
header.header{display:grid;grid-template-columns:1fr;gap:12px;align-items:center;margin-bottom:12px}
@media(min-width:760px){header.header{grid-template-columns:1fr auto}}
.brand{
  background:linear-gradient(135deg, rgba(34,211,238,.16), rgba(167,139,250,.16));
  border:1px solid var(--border); border-radius:16px; padding:12px 14px; box-shadow:var(--shadow);
  display:flex;flex-direction:column;gap:6px;min-height:96px
}
.brand h1{margin:0;font-weight:800;letter-spacing:.2px;font-size:1.16rem}
.meta{display:flex;flex-wrap:wrap;gap:8px 12px;color:var(--muted);font-size:.86rem}
.controls{display:grid;gap:8px;align-items:center;grid-template-columns:1fr auto}
@media(min-width:840px){.controls{grid-template-columns:auto auto;justify-content:end}}
select#scan-select{
  flex:1 1 auto;width:100%;appearance:none;background:linear-gradient(180deg,#0c1424,#0c1528);
  color:var(--text);border:1px solid var(--border);border-radius:12px;padding:12px 40px 12px 12px;font-weight:600;outline:0;box-shadow:var(--shadow);height:44px
}
.hamburger{
  position:relative;width:44px;height:44px;border-radius:12px;border:1px solid var(--border);
  background:linear-gradient(180deg,#0c1420,#0c1426);display:flex;align-items:center;justify-content:center;
  box-shadow:var(--shadow),0 0 18px rgba(34,211,238,.25);cursor:pointer
}
.hamburger:hover{transform:translateY(-2px);transition:transform .15s ease, box-shadow .15s ease}
.hamburger .bars{position:relative;width:22px;height:16px;display:block}
.hamburger .bars span{position:absolute;left:0;right:0;height:2px;background:var(--cyan);border-radius:2px;box-shadow:0 0 10px rgba(34,211,238,.7)}
.hamburger .bars span:nth-child(1){top:0}
.hamburger .bars span:nth-child(2){top:7px}
.hamburger .bars span:nth-child(3){bottom:0}

.segmented{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
.segmented .label{color:var(--muted);font-size:.86rem;margin-right:4px}
.segmented input{position:absolute;opacity:0;pointer-events:none}
.segmented label{position:relative;padding:8px 10px;border-radius:999px;border:1px solid var(--border);
  background:linear-gradient(180deg,#0c1424,#0c1528);cursor:pointer;font-weight:600;font-size:.86rem}
.segmented label:has(input:checked){
  border-color:rgba(167,139,250,.45);
  box-shadow:0 0 0 1px rgba(167,139,250,.25) inset, 0 0 14px rgba(167,139,250,.18);
  background:linear-gradient(180deg,#0d1a2b,#0e1e34);
}

.grid{display:grid;gap:10px}
.card{
  background:linear-gradient(180deg,var(--panel),var(--panel-2));
  border:1px solid var(--border);border-radius:16px;padding:10px;box-shadow:var(--shadow);
  position:relative;overflow:hidden;transform:translateY(6px);opacity:0;animation:fadeUp .5s ease forwards
}
.card:hover{transform:translateY(-2px);box-shadow:var(--shadow),0 0 24px rgba(167,139,250,.15),0 0 0 1px rgba(255,255,255,.04) inset;transition:.16s}
@keyframes fadeUp{to{opacity:1;transform:translateY(0)}}
@media(prefers-reduced-motion:reduce){.card{animation:none;opacity:1;transform:none}.card:hover{transition:none}}

.small{font-size:.86rem;color:var(--muted)}
.section-title{margin:16px 0 8px;font-weight:800;font-size:1.05rem;letter-spacing:.3px}

.kpis{grid-template-columns:1fr 1fr}
@media(min-width:740px){.kpis{grid-template-columns:repeat(4,1fr)}} 
@media(min-width:1024px){.kpis{grid-template-columns:repeat(8,1fr)}}
.kpi{display:grid;grid-template-columns:auto 1fr;gap:10px;align-items:center}
.kpi h4{margin:0 0 4px 0;font-size:.9rem;color:var(--muted);font-weight:600}
.val-big{font-weight:800;font-size:1.02rem}
.unit{font-size:.78rem;color:var(--muted)}
.delta{margin-top:6px;display:inline-flex;align-items:center;gap:6px;font-size:.78rem;padding:4px 8px;border-radius:999px;border:1px solid var(--border);background:#0d1525}
.delta.good{color:#c8f7dc;box-shadow:0 0 0 1px rgba(52,211,153,.25) inset, 0 0 12px rgba(52,211,153,.12)}
.delta.bad{color:#ffd7d7;box-shadow:0 0 0 1px rgba(248,113,113,.25) inset, 0 0 12px rgba(248,113,113,.12)}
.delta.neutral{color:#d1d5db;box-shadow:0 0 0 1px rgba(255,255,255,.12) inset}
.gauge{--size:52px;--track:7px;--val:0;--max:100;--hue:190;width:var(--size);height:var(--size);border-radius:50%;
  background:conic-gradient(hsl(var(--hue),95%,62%) calc(var(--val)/var(--max)*1turn), rgba(255,255,255,.08) 0);display:grid;place-items:center;transition:background .6s ease;box-shadow:inset 0 0 12px rgba(0,0,0,.35),0 0 18px rgba(34,211,238,.15)}
.gauge::after{content:"";width:calc(var(--size) - var(--track)*2);height:calc(var(--size) - var(--track)*2);border-radius:50%;background:linear-gradient(180deg,#0a0f1a,#0b1220);box-shadow: inset 0 0 0 1px var(--border)}
.gval{position:absolute;width:var(--size);text-align:center;font-weight:800;font-size:.9rem;letter-spacing:.2px}
.badge{min-width:48px;min-height:48px;border-radius:50%;display:grid;place-items:center;border:1px solid var(--border);background:linear-gradient(180deg,#0c1424,#0c1528);box-shadow:var(--shadow)}

.compare{display:grid;gap:10px}
@media(min-width:560px){.compare{grid-template-columns:repeat(2,1fr)}}
@media(min-width:900px){.compare{grid-template-columns:repeat(3,1fr)}}
@media(min-width:1120px){.compare{grid-template-columns:repeat(4,1fr)}}
.mini{padding:10px}
.mini h5{margin:0 0 6px 0;font-size:.9rem;color:var(--muted)}
.mini .delta{margin:0 0 6px 0}
.mini .fromto{font-size:.82rem;color:var(--muted)}

.segments{display:grid;gap:10px}
@media(min-width:900px){.segments{grid-template-columns:1fr 1fr}}
.sil-body{position:relative;min-height:260px;display:grid;place-items:center}
.human{width:150px;height:230px;opacity:.9;filter:drop-shadow(0 0 16px rgba(167,139,250,.12))}
.box{position:absolute;min-width:110px;padding:8px 10px;border:1px solid var(--border);border-radius:12px;background:linear-gradient(180deg,#0c1424,#0d1528);box-shadow:var(--shadow);font-size:.86rem}
.box .name{color:var(--muted);font-size:.78rem} .box .val{font-weight:800}
.la{left:-10px;top:60px} .ra{right:-10px;top:60px} .tr{left:50%;transform:translateX(-50%);top:10px} .ll{left:-10px;bottom:26px} .rl{right:-10px;bottom:26px}

.ior-table{width:100%;border-collapse:collapse;font-size:.9rem}
.ior-table th,.ior-table td{padding:10px;border-top:1px solid var(--border);border-bottom:1px solid var(--border);text-align:left;vertical-align:top}
.ior-table th{color:var(--muted);font-weight:600;width:140px}
.big-ior h4{margin:0 0 8px 0}

details.repo{padding:12px} details.repo summary{cursor:pointer;list-style:none;font-weight:800}
.table-wrap{overflow:auto;margin-top:10px;border-top:1px solid var(--border)}
table.master{width:max(100%,960px);border-collapse:collapse;font-size:.9rem}
table.master th,table.master td{border-bottom:1px solid var(--border);padding:8px 10px;text-align:left;vertical-align:top}
table.master th{position:sticky;top:0;background:#0d1424;z-index:1}

.compare-controls{display:flex;justify-content:space-between;align-items:center;gap:8px;margin-top:6px}
#compare-baseline-label{color:var(--muted);margin-left:6px}

.forecast{display:grid;gap:10px}
@media(min-width:760px){.forecast{grid-template-columns:repeat(3,1fr)}}
.f-item h5{margin:0 0 6px 0;font-size:.92rem;color:var(--muted)}
.f-vals{display:flex;gap:8px;flex-wrap:wrap}
.f-chip{padding:6px 10px;border-radius:10px;border:1px solid var(--border);background:linear-gradient(180deg,#0c1424,#0c1528);font-weight:700}
.f-note{font-size:.82rem;color:var(--muted);margin-top:6px}
.f-delta.good{color:#c8f7dc}.f-delta.bad{color:#ffd7d7}.f-delta.neutral{color:#d1d5db}

table.milestones{width:100%;border-collapse:collapse;font-size:.9rem;margin-top:4px}
table.milestones th, table.milestones td{border-bottom:1px solid var(--border);padding:8px 10px;text-align:left}

.meal h4{margin:0 0 8px 0}
.day{margin-bottom:8px}
.day h5{margin:6px 0 4px 0}
.badge-kcal{display:inline-block;margin-left:6px;padding:4px 8px;border-radius:999px;border:1px solid var(--border);background:#0d1525;font-size:.82rem}
.grocery{columns:2;column-gap:12px}
@media(max-width:560px){.grocery{columns:1}}

.menu{position:fixed;inset:0;background:rgba(7,10,17,.88);backdrop-filter:blur(8px);display:none;z-index:60;padding:20px}
.menu .inner{max-width:1120px;margin:0 auto;display:flex;flex-direction:column;min-height:100%}
.menu .content{margin:auto 0;display:flex;flex-direction:column;gap:12px}
.menu .pill{display:inline-block;margin:0 8px 8px 0;padding:10px 14px;border:1px solid var(--border);border-radius:999px;background:linear-gradient(180deg,#0e1526,#0e1629)}
.menu .close{align-self:flex-end;color:var(--cyan);cursor:pointer;text-decoration:underline}
</style>
</head>
<body>
<div class="container">

  <!-- Header -->
  <header class="header">
    <div class="brand">
      <h1>InBody Tracker</h1>
      <div class="meta">
        <div id="last-scan">Last scan: -</div>
        <div class="small" id="debug">- Loaded 0 scans (source: -) | options: 0</div>
      </div>
    </div>
    <div class="controls">
      <select id="scan-select" aria-label="Select scan"></select>
      <button class="hamburger" id="btn-menu" aria-label="Open menu">
        <span class="bars" aria-hidden="true"><span></span><span></span><span></span></span>
      </button>
    </div>
  </header>

  <!-- KPI Row (8 cards) -->
  <section class="grid kpis" id="kpi-row">
    <!-- Weight -->
    <div class="card">
      <div class="kpi">
        <div class="gauge" id="g-weight" style="--hue:190"><div class="gval" id="gv-weight">-</div></div>
        <div>
          <h4>Body Weight</h4>
          <div class="val-big" id="m-weight">-</div>
          <div class="unit">kg</div>
          <div class="delta neutral" id="d-weight">No previous scan to compare</div>
        </div>
      </div>
    </div>
    <!-- SMM -->
    <div class="card">
      <div class="kpi">
        <div class="gauge" id="g-smm" style="--hue:160; --max:45"><div class="gval" id="gv-smm">-</div></div>
        <div>
          <h4>Skeletal Muscle Mass</h4>
          <div class="val-big" id="m-smm">-</div>
          <div class="unit">kg</div>
          <div class="delta neutral" id="d-smm">No previous scan to compare</div>
        </div>
      </div>
    </div>
    <!-- PBF -->
    <div class="card">
      <div class="kpi">
        <div class="gauge" id="g-pbf" style="--hue:270; --max:60"><div class="gval" id="gv-pbf">-</div></div>
        <div>
          <h4>Percent Body Fat</h4>
          <div class="val-big" id="m-pbf">-</div>
          <div class="unit">%</div>
          <div class="delta neutral" id="d-pbf">No previous scan to compare</div>
        </div>
      </div>
    </div>
    <!-- Obesity -->
    <div class="card">
      <div class="kpi">
        <div class="gauge" id="g-obesity" style="--hue:12; --max:200"><div class="gval" id="gv-obesity">-</div></div>
        <div>
          <h4>Obesity Degree</h4>
          <div class="val-big" id="m-obesity">-</div>
          <div class="unit">%</div>
          <div class="delta neutral" id="d-obesity">No previous scan to compare</div>
        </div>
      </div>
    </div>
    <!-- Visceral -->
    <div class="card">
      <div class="kpi">
        <div class="gauge" id="g-visc" style="--hue:8; --max:20"><div class="gval" id="gv-visc">-</div></div>
        <div>
          <h4>Visceral Fat Level</h4>
          <div class="val-big" id="m-visc">-</div>
          <div class="unit">level</div>
          <div class="delta neutral" id="d-visc">No previous scan to compare</div>
        </div>
      </div>
    </div>
    <!-- BMR -->
    <div class="card">
      <div class="kpi">
        <div class="gauge" id="g-bmr" style="--hue:42; --max:2200"><div class="gval" id="gv-bmr">-</div></div>
        <div>
          <h4>Basal Metabolic Rate</h4>
          <div class="val-big" id="m-bmr">-</div>
          <div class="unit">kcal</div>
          <div class="delta neutral" id="d-bmr">No previous scan to compare</div>
        </div>
      </div>
    </div>
    <!-- Deficit -->
    <div class="card">
      <div class="kpi">
        <div class="badge" id="badge-deficit"></div>
        <div>
          <h4>Calorie Deficit Target</h4>
          <div class="val-big" id="m-deficit">-</div>
          <div class="unit" id="m-deficit-range">range -</div>
          <div class="delta neutral" id="d-deficit">No previous scan to compare</div>
        </div>
      </div>
    </div>
    <!-- Score -->
    <div class="card">
      <div class="kpi">
        <div class="gauge" id="g-score" style="--hue:150; --max:100"><div class="gval" id="gv-score">-</div></div>
        <div>
          <h4>InBody Score</h4>
          <div class="val-big" id="m-score">-</div>
          <div class="unit">/ 100</div>
          <div class="delta neutral" id="d-score">No previous scan to compare</div>
        </div>
      </div>
    </div>
  </section>

  <!-- Compare toggle -->
  <div class="compare-controls">
    <fieldset id="compare-mode" aria-label="Compare to" class="segmented">
      <span class="label">Compare to:</span>
      <label><input type="radio" name="compareMode" value="previous" checked> Previous</label>
      <label><input type="radio" name="compareMode" value="baseline"> Baseline</label>
      <span id="compare-baseline-label" class="small"></span>
    </fieldset>
  </div>
  <h3 class="section-title" id="compare-title">Changes Compared With Previous Scan</h3>
  <section class="compare" id="compare-strip"></section>

  <!-- Overall I-O-R -->
  <section class="card big-ior" style="margin-top:10px">
    <h4>🤖 Overall Insight - Observation - Recommendation</h4>
    <p><strong>Insight:</strong> <span id="overall-insight">-</span></p>
    <p><strong>Observation:</strong> <span id="overall-observation">-</span></p>
    <p><strong>Recommendation:</strong> <span id="overall-reco">-</span></p>
  </section>

  <!-- Panels without charts -->
  <h3 class="section-title">Composition + BMI/PBF</h3>
  <section class="card">
    <h4>🤖 I-O-R</h4>
    <table class="ior-table">
      <tr><th>Insight</th><td id="ior-composition-insight">-</td></tr>
      <tr><th>Observation</th><td id="ior-composition-observation">-</td></tr>
      <tr><th>Recommendation</th><td id="ior-composition-reco">-</td></tr>
    </table>
  </section>

  <h3 class="section-title">Metabolic & Fluids</h3>
  <section class="card">
    <h4>🤖 I-O-R</h4>
    <table class="ior-table">
      <tr><th>Insight</th><td id="ior-bmr-insight">-</td></tr>
      <tr><th>Observation</th><td id="ior-bmr-observation">-</td></tr>
      <tr><th>Recommendation</th><td id="ior-bmr-reco">-</td></tr>
    </table>
  </section>

  <h3 class="section-title">Segmental Analysis</h3>
  <section class="segments">
    <div class="card">
      <h4>Segmental Lean (Muscle)</h4>
      <div class="sil-body">
        <svg class="human" viewBox="0 0 120 180" aria-hidden="true">
          <defs><linearGradient id="grad" x1="0" y1="0" x2="0" y2="1"><stop offset="0%" stop-color="#1b2538"/><stop offset="100%" stop-color="#0f1726"/></linearGradient></defs>
        <g fill="url(#grad)" stroke="rgba(255,255,255,0.06)" stroke-width="1">
          <ellipse cx="60" cy="20" rx="16" ry="16"/><rect x="44" y="36" width="32" height="46" rx="10"/>
          <rect x="22" y="42" width="18" height="42" rx="9"/><rect x="80" y="42" width="18" height="42" rx="9"/>
          <rect x="40" y="84" width="16" height="70" rx="8"/><rect x="64" y="84" width="16" height="70" rx="8"/>
        </g></svg>
        <div class="box la"><div class="name">LA</div><div class="val" id="lean-la">-</div></div>
        <div class="box ra"><div class="name">RA</div><div class="val" id="lean-ra">-</div></div>
        <div class="box tr"><div class="name">Trunk</div><div class="val" id="lean-tr">-</div></div>
        <div class="box ll"><div class="name">LL</div><div class="val" id="lean-ll">-</div></div>
        <div class="box rl"><div class="name">RL</div><div class="val" id="lean-rl">-</div></div>
      </div>
      <section class="card" style="margin-top:10px">
        <h4>🤖 I-O-R</h4>
        <table class="ior-table">
          <tr><th>Insight</th><td id="ior-lean-insight">-</td></tr>
          <tr><th>Observation</th><td id="ior-lean-observation">-</td></tr>
          <tr><th>Recommendation</th><td id="ior-lean-reco">-</td></tr>
        </table>
      </section>
    </div>

    <div class="card">
      <h4>Segmental Fat (Fat)</h4>
      <div class="sil-body">
        <svg class="human" viewBox="0 0 120 180" aria-hidden="true">
          <defs><linearGradient id="grad2" x1="0" y1="0" x2="0" y2="1"><stop offset="0%" stop-color="#1b2538"/><stop offset="100%" stop-color="#0f1726"/></linearGradient></defs>
        <g fill="url(#grad2)" stroke="rgba(255,255,255,0.06)" stroke-width="1">
          <ellipse cx="60" cy="20" rx="16" ry="16"/><rect x="44" y="36" width="32" height="46" rx="10"/>
          <rect x="22" y="42" width="18" height="42" rx="9"/><rect x="80" y="42" width="18" height="42" rx="9"/>
          <rect x="40" y="84" width="16" height="70" rx="8"/><rect x="64" y="84" width="16" height="70" rx="8"/>
        </g></svg>
        <div class="box la"><div class="name">LA</div><div class="val" id="fat-la">-</div></div>
        <div class="box ra"><div class="name">RA</div><div class="val" id="fat-ra">-</div></div>
        <div class="box tr"><div class="name">Trunk</div><div class="val" id="fat-tr">-</div></div>
        <div class="box ll"><div class="name">LL</div><div class="val" id="fat-ll">-</div></div>
        <div class="box rl"><div class="name">RL</div><div class="val" id="fat-rl">-</div></div>
      </div>
      <section class="card" style="margin-top:10px">
        <h4>🤖 I-O-R</h4>
        <table class="ior-table">
          <tr><th>Insight</th><td id="ior-fat-insight">-</td></tr>
          <tr><th>Observation</th><td id="ior-fat-observation">-</td></tr>
          <tr><th>Recommendation</th><td id="ior-fat-reco">-</td></tr>
        </table>
      </section>
    </div>
  </section>

  <!-- Repository -->
  <details class="repo" style="margin-top:12px">
    <summary>Data Repository (master table)</summary>
    <div class="table-wrap">
      <table class="master" id="repo-table">
        <thead>
          <tr>
            <th>Date</th><th>Label</th>
            <th>Weight</th><th>Percent Body Fat</th><th>Body Mass Index</th><th>InBody Score</th>
            <th>Visceral Fat Level</th><th>Skeletal Muscle Mass</th><th>Fat Mass</th><th>Basal Metabolic Rate</th>
            <th>Total Body Water</th><th>Protein</th><th>Minerals</th><th>Fat-Free Mass</th><th>Obesity Degree</th><th>ECW/TBW</th>
            <th>I-O-R composition</th><th>I-O-R bmi_pbf</th><th>I-O-R bmr_obesity</th><th>I-O-R ecwtbw</th>
            <th>I-O-R segmental_lean</th><th>I-O-R segmental_fat</th><th>I-O-R overall</th>
          </tr>
        </thead>
        <tbody id="repo-body"></tbody>
      </table>
    </div>
  </details>

  <!-- Forecast + Meal Plan -->
  <h3 class="section-title">Forecast (12 weeks) - Weight, Skeletal Muscle Index, Percent Body Fat</h3>
  <section class="forecast" id="forecast-cards">
    <div class="card f-item" id="fc-weight"><h5>Projected Body Weight</h5><div class="f-vals" id="fcw-vals"></div><div class="f-note" id="fcw-note"></div></div>
    <div class="card f-item" id="fc-smi"><h5>Projected Skeletal Muscle Index</h5><div class="f-vals" id="fcs-vals"></div><div class="f-note" id="fcs-note"></div></div>
    <div class="card f-item" id="fc-pbf"><h5>Projected Percent Body Fat</h5><div class="f-vals" id="fcp-vals"></div><div class="f-note" id="fcp-note"></div></div>
  </section>
  <section class="card" style="margin-top:10px">
    <h4>Milestones (Today, +2w, +4w, +12w)</h4>
    <div class="table-wrap"><table class="milestones" id="milestones"><thead><tr><th>Date</th><th>Weight (kg)</th><th>SMI (kg/m^2)</th><th>PBF (%)</th><th>Delta vs Today</th></tr></thead><tbody></tbody></table></div>
  </section>

  <section class="card meal" style="margin-top:10px">
    <h4>Meal Plan (deficit aligned)</h4>
    <p class="small" id="meal-summary">-</p>
    <div id="meal-days"></div>
    <h5>Grocery List (condensed)</h5>
    <div class="grocery small" id="grocery"></div>
    <p class="small" style="margin-top:6px">Note: guidance only, not medical advice.</p>
  </section>

  <!-- Data Source (BOTTOM) -->
  <section class="card" id="data-source" style="margin-top:12px">
    <h3 style="margin:0 0 8px 0;font-size:.98rem">Data Source</h3>
    <div class="grid" style="grid-template-columns:1fr;gap:8px">
      <div class="card" style="padding:8px">
        <table class="ds-table" style="width:100%;border-collapse:collapse;font-size:.9rem">
          <tbody>
            <tr><th style="text-align:left;color:var(--muted);width:160px;padding:8px 10px;border-bottom:1px solid var(--border)">Source</th><td id="ds-source" style="padding:8px 10px;border-bottom:1px solid var(--border)">-</td></tr>
            <tr><th style="text-align:left;color:var(--muted);padding:8px 10px;border-bottom:1px solid var(--border)">Loaded</th><td id="ds-loaded" style="padding:8px 10px;border-bottom:1px solid var(--border)">-</td></tr>
            <tr><th style="text-align:left;color:var(--muted);padding:8px 10px;border-bottom:1px solid var(--border)">Records</th><td id="ds-records" style="padding:8px 10px;border-bottom:1px solid var(--border)">-</td></tr>
            <tr><th style="text-align:left;color:var(--muted);padding:8px 10px;border-bottom:1px solid var(--border)">Latest Label</th><td id="ds-latest-label" style="padding:8px 10px;border-bottom:1px solid var(--border)">-</td></tr>
            <tr><th style="text-align:left;color:var(--muted);padding:8px 10px;border-bottom:1px solid var(--border)">Latest Date</th><td id="ds-latest-date" style="padding:8px 10px;border-bottom:1px solid var(--border)">-</td></tr>
            <tr><th style="text-align:left;color:var(--muted);padding:8px 10px;border-bottom:1px solid var(--border)">Notes</th><td id="ds-notes" style="padding:8px 10px;border-bottom:1px solid var(--border)">-</td></tr>
          </tbody>
        </table>
        <div class="small" id="ds-debug" style="margin-top:6px">-</div>
      </div>
      <div class="card" style="padding:8px">
        <details>
          <summary style="cursor:pointer;font-weight:700">Raw Data (JSON)</summary>
          <pre id="raw-json" style="max-height:300px;overflow:auto;margin:8px 0 0;border:1px solid var(--border);border-radius:8px;padding:8px;background:#0a0f1a;color:#dfe3ea;font-size:.82rem"></pre>
        </details>
      </div>
    </div>
  </section>

</div>

<!-- Embedded JSON -->
<script type="application/json" id="scans-json">{"scans":[{"date":"2025-03-01","label":"Mar 2025 (est.)","metrics":{"weight":90.0,"pbf":42.0,"bmi":31.9,"score":62,"visceral":15,"smm":32.0,"fat":38.0,"bmr":1750,"tbw":42.5,"protein":11.2,"minerals":3.8,"ffm":52.0,"obesity":145.0,"ecwtbw":0.390},"segments_lean":{"la":{"kg":3.00,"pct":98.0},"ra":{"kg":3.10,"pct":98.5},"tr":{"kg":21.0,"pct":99.0},"ll":{"kg":9.40,"pct":97.5},"rl":{"kg":9.50,"pct":98.0}},"segments_fat":{"la":{"kg":3.04,"pct":8.0},"ra":{"kg":3.04,"pct":8.0},"tr":{"kg":19.0,"pct":50.0},"ll":{"kg":6.46,"pct":17.0},"rl":{"kg":6.46,"pct":17.0}},"ior":{"composition":{"insight":"Fat dominant","observation":"High fat, lower muscle relative","recommendation":"Deficit + protein >= 1.6 g/kg"},"bmi_pbf":{"insight":"BMI and PBF high","observation":"BMI 31.9, PBF 42%","recommendation":"Add waist/hip tracking"},"bmr_obesity":{"insight":"BMR high due to mass","observation":"1750 kcal baseline","recommendation":"Moderate deficit 300-500"},"ecwtbw":{"insight":"Hydration high side","observation":"ECW/TBW 0.390","recommendation":"Control sodium"},"segmental_lean":{"insight":"Balanced limbs, trunk heavy","observation":"~97-99% of standard","recommendation":"Balanced training"},"segmental_fat":{"insight":"Central fat heavy (est)","observation":"Trunk 50% share","recommendation":"Prioritize trunk fat loss"},"overall":{"insight":"Obese baseline","observation":"VF 15, obesity 145%","recommendation":"Initiate fat-loss"}}},{"date":"2025-04-15","label":"Mid-Apr 2025 (est.)","metrics":{"weight":84.7,"pbf":39.6,"bmi":30.0,"score":63,"visceral":14,"smm":31.2,"fat":33.5,"bmr":1700,"tbw":41.0,"protein":10.9,"minerals":3.7,"ffm":51.2,"obesity":139.0,"ecwtbw":0.389},"segments_lean":{"la":{"kg":2.90,"pct":97.8},"ra":{"kg":3.00,"pct":98.2},"tr":{"kg":20.5,"pct":98.5},"ll":{"kg":9.20,"pct":97.2},"rl":{"kg":9.30,"pct":97.6}},"segments_fat":{"la":{"kg":2.68,"pct":8.0},"ra":{"kg":2.68,"pct":8.0},"tr":{"kg":16.75,"pct":50.0},"ll":{"kg":5.70,"pct":17.0},"rl":{"kg":5.70,"pct":17.0}},"ior":{"composition":{"insight":"Early fat drop","observation":"~5 kg fat loss","recommendation":"Add resistance training"},"bmi_pbf":{"insight":"PBF down faster than BMI","observation":"PBF 39.6, BMI 30.0","recommendation":"Loss <= 0.7% BW/week"},"bmr_obesity":{"insight":"BMR slightly down","observation":"1700 kcal","recommendation":"Avoid aggressive cuts"},"ecwtbw":{"insight":"Hydration stable","observation":"0.389","recommendation":"35-40 ml/kg"},"segmental_lean":{"insight":"Balanced limbs","observation":"Arms 98%, legs 97%","recommendation":"Add squats/deadlifts"},"segmental_fat":{"insight":"Fat down modest","observation":"VF down 1","recommendation":"2-3 cardio/week"},"overall":{"insight":"Good start","observation":"-5.3 kg total","recommendation":"Sustain momentum"}}},{"date":"2025-06-13","label":"13 Jun 2025 (scan)","metrics":{"weight":80.6,"pbf":32.6,"bmi":28.6,"score":65,"visceral":12,"smm":30.4,"fat":26.2,"bmr":1544,"tbw":39.9,"protein":10.7,"minerals":3.75,"ffm":54.4,"obesity":130.0,"ecwtbw":0.388},"segments_lean":{"la":{"kg":3.05,"pct":95.7},"ra":{"kg":3.12,"pct":97.9},"tr":{"kg":24.8,"pct":97.6},"ll":{"kg":8.09,"pct":91.3},"rl":{"kg":8.16,"pct":92.0}},"segments_fat":{"la":{"kg":1.90,"pct":333.8},"ra":{"kg":1.90,"pct":323.6},"tr":{"kg":14.10,"pct":358.4},"ll":{"kg":3.50,"pct":223.9},"rl":{"kg":3.60,"pct":225.8}},"ior":{"composition":{"insight":"Strong fat loss","observation":"Fat -11.8, SMM -1.6","recommendation":"Keep deficit; carbs pre-workout"},"bmi_pbf":{"insight":"PBF dropping faster","observation":"BMI 28.6, PBF 32.6%","recommendation":"Use tape and photos"},"bmr_obesity":{"insight":"BMR stable","observation":"1544 kcal","recommendation":"Deficit 300-500 kcal"},"ecwtbw":{"insight":"Hydration healthy","observation":"0.388","recommendation":"Maintain electrolytes"},"segmental_lean":{"insight":"Legs weak","observation":"LL 91%, RL 92%","recommendation":"Unilateral work"},"segmental_fat":{"insight":"Central fat high","observation":"Trunk 14.1 kg (358%)","recommendation":"Aerobic + core stability"},"overall":{"insight":"Overfat improving","observation":"VF 12","recommendation":"Push to VF < 10"}}},{"date":"2025-09-11","label":"11 Sep 2025 (scan)","metrics":{"weight":79.0,"pbf":31.3,"bmi":28.0,"score":66,"visceral":10,"smm":30.4,"fat":24.8,"bmr":1542,"tbw":39.8,"protein":10.6,"minerals":3.75,"ffm":54.2,"obesity":127.9,"ecwtbw":0.388},"segments_lean":{"la":{"kg":3.00,"pct":94.6},"ra":{"kg":3.03,"pct":95.6},"tr":{"kg":24.4,"pct":96.6},"ll":{"kg":8.15,"pct":92.6},"rl":{"kg":8.19,"pct":92.9}},"segments_fat":{"la":{"kg":1.70,"pct":303.4},"ra":{"kg":1.70,"pct":298.3},"tr":{"kg":13.20,"pct":334.8},"ll":{"kg":3.50,"pct":217.6},"rl":{"kg":3.50,"pct":218.5}},"ior":{"composition":{"insight":"Progress steady","observation":"Muscle stable, fat down","recommendation":"Lift 2-3x/week"},"bmi_pbf":{"insight":"PBF steady drop","observation":"BMI 28.0, PBF 31.3%","recommendation":"~0.5% BW loss/week"},"bmr_obesity":{"insight":"BMR stable","observation":"1542 kcal","recommendation":"Avoid further drop"},"ecwtbw":{"insight":"Hydration steady","observation":"0.388","recommendation":"~3 L/day"},"segmental_lean":{"insight":"Arms/trunk solid, legs lag","observation":"Legs ~92%","recommendation":"Leg hypertrophy focus"},"segmental_fat":{"insight":"Central fat dropping","observation":"VF 10","recommendation":"Add HIIT block"},"overall":{"insight":"Near overweight","observation":"VF 10","recommendation":"Push to VF <= 9"}}},{"date":"2025-09-24","label":"24 Sep 2025 (scan)","metrics":{"weight":76.8,"pbf":29.7,"bmi":27.2,"score":68,"visceral":9,"smm":30.2,"fat":22.8,"bmr":1536,"tbw":39.6,"protein":10.6,"minerals":3.75,"ffm":54.0,"obesity":124.8,"ecwtbw":0.387},"segments_lean":{"la":{"kg":3.01,"pct":96.6},"ra":{"kg":3.08,"pct":98.2},"tr":{"kg":24.4,"pct":97.4},"ll":{"kg":7.87,"pct":90.9},"rl":{"kg":7.94,"pct":90.9}},"segments_fat":{"la":{"kg":1.50,"pct":274.2},"ra":{"kg":1.50,"pct":271.7},"tr":{"kg":12.30,"pct":314.1},"ll":{"kg":3.10,"pct":192.5},"rl":{"kg":3.10,"pct":194.0}},"ior":{"composition":{"insight":"Milestone","observation":"Fat -15.2, muscle stable","recommendation":"Start recomposition"},"bmi_pbf":{"insight":"BMI vs PBF gap","observation":"BMI 27.2, PBF 29.7%","recommendation":"Aim PBF <= 25%"},"bmr_obesity":{"insight":"BMR stable","observation":"1536 kcal","recommendation":"Preserve strength"},"ecwtbw":{"insight":"Hydration optimal","observation":"0.387","recommendation":"Maintain intake"},"segmental_lean":{"insight":"Legs lag","observation":"~91%","recommendation":"Lower-body overload"},"segmental_fat":{"insight":"Abdominal fat down","observation":"VF 9","recommendation":"Transition to recomp + diet breaks"},"overall":{"insight":"Obese to overweight","observation":"-13.2 kg; ~85% fat loss; VF 9","recommendation":"Next: 72 kg, PBF <= 25%, VF <= 7"}}}]}</script>

<script>
(function(){
  'use strict';
  const $=id=>document.getElementById(id);
  const sel=$('scan-select');
  const compareFieldset=$('compare-mode');
  const compareTitle=$('compare-title');
  const compareBaselineLabel=$('compare-baseline-label');

  // Parse JSON or fallback
  const raw = $('scans-json')?.textContent || '{}';
  let scans=[], source='json';
  try{ const j=JSON.parse(raw); scans=Array.isArray(j.scans)?j.scans:[]; if(!scans.length) throw 0; }
  catch(e){ source='fallback'; scans=(JSON.parse('{"scans":[]}').scans); }

  // Helpers
  const fmt=(v,d=1)=> (v==null||Number.isNaN(v))?'-':Number(v).toFixed(d);
  const setGauge=(el,val,max,text)=>{ if(!el) return; el.style.setProperty('--val',Number(val||0)); el.style.setProperty('--max',Number(max||100)); const gv=el.querySelector('.gval'); if(gv) gv.textContent=text??fmt(val,(max<=100?1:0)); };
  const segFmt=o=>`${(o?.kg==null)?'-':fmt(o.kg,2)+' kg'} | ${(o?.pct==null)?'-':fmt(o.pct,1)+' %'}`;
  const prevIndex=i=> i>0 ? i-1 : -1;
  const baselineIndex=0;

  // State (persisted)
  const getCompareMode=()=> localStorage.getItem('compareMode') || 'previous';
  const setCompareMode=v=> localStorage.setItem('compareMode', v);

  function mountSelect(list){
    sel.innerHTML = list.map((s,i)=>`<option value="${i}">${s.label} - ${s.date}</option>`).join('');
    sel.selectedIndex = list.length-1;
    updateDebug();
    renderAll(sel.selectedIndex);
  }

  function parseRange(text){
    const m=(text||'').match(/(\d+)\s*-\s*(\d+)/); if(!m) return null;
    let a=+m[1], b=+m[2]; if(a>b){const t=a;a=b;b=t;} return [a,b];
  }
  const clamp=(v,min,max)=>Math.min(max,Math.max(min,v));
  const r10=v=>Math.round(v/10)*10;

  function deficitFor(scan){
    const rec=scan?.ior?.bmr_obesity?.recommendation||'';
    let range=parseRange(rec);
    if(!range){
      const bmr=Number(scan?.metrics?.bmr||0), tdee=bmr*1.35;
      let lo=r10(tdee*0.15), hi=r10(tdee*0.20);
      lo=clamp(lo,250,750); hi=clamp(hi,250,750); if(hi<lo){const t=lo;lo=hi;hi=t;}
      range=[lo,hi];
    }
    return {range, mid:r10((range[0]+range[1])/2)};
  }

  const goodDown=new Set(["Body Weight","Percent Body Fat","Visceral Fat Level","Obesity Degree","Fat Mass"]);
  const goodUp  =new Set(["Skeletal Muscle Mass","Basal Metabolic Rate","InBody Score"]);
  function delta(curr,prev,name,unit,modeLabel){
    if(prev==null) return {text:`No ${modeLabel} scan to compare`, cls:"neutral"};
    const d=Number(curr)-Number(prev), abs=Math.abs(d);
    const arrow=d>0?"▲":d<0?"▼":"•", sign=d>0?"+":d<0?"-":"";
    const decimals=(unit==="/ 100"||unit==="level")?0:1;
    const text=`${arrow} ${sign}${abs.toFixed(decimals)} ${unit} since ${modeLabel}`.trim();
    let cls="neutral";
    if(d===0) cls="neutral";
    else if((d<0&&goodDown.has(name))||(d>0&&goodUp.has(name))) cls="good";
    else cls="bad";
    return {text,cls};
  }

  function renderDataSource(){
    const latest=scans[scans.length-1]||{};
    $('ds-source').textContent=(source==='json')?'Embedded JSON (scans-json)':'Fallback Array';
    $('ds-loaded').textContent=scans.length?'Yes':'No';
    $('ds-records').textContent=String(scans.length);
    $('ds-latest-label').textContent=latest.label||'-';
    $('ds-latest-date').textContent=latest.date||'-';
    $('ds-notes').textContent='Renderer: none (charts removed)';
    const dbg=`- Loaded ${scans.length} scans (source: ${source}) | options: ${sel.options.length}`;
    $('ds-debug').textContent=dbg; $('debug').textContent=dbg;
    try{ $('raw-json').textContent=JSON.stringify({scans},null,2);}catch(_){}
  }

  function renderRepo(items){
    $('repo-body').innerHTML = items.map(s=>{
      const m=s.metrics,i=s.ior;
      return `<tr>
        <td>${s.date}</td><td>${s.label}</td>
        <td>${fmt(m.weight,1)}</td><td>${fmt(m.pbf,1)}</td><td>${fmt(m.bmi,1)}</td><td>${fmt(m.score,0)}</td>
        <td>${m.visceral}</td><td>${fmt(m.smm,1)}</td><td>${fmt(m.fat,1)}</td><td>${Math.round(m.bmr)}</td>
        <td>${fmt(m.tbw,1)}</td><td>${fmt(m.protein,1)}</td><td>${fmt(m.minerals,2)}</td><td>${fmt(m.ffm,1)}</td>
        <td>${fmt(m.obesity,1)}</td><td>${fmt(m.ecwtbw,3)}</td>
        <td>${i.composition.insight} - ${i.composition.observation} - ${i.composition.recommendation}</td>
        <td>${i.bmi_pbf.insight} - ${i.bmi_pbf.observation} - ${i.bmi_pbf.recommendation}</td>
        <td>${i.bmr_obesity.insight} - ${i.bmr_obesity.observation} - ${i.bmr_obesity.recommendation}</td>
        <td>${i.ecwtbw.insight} - ${i.ecwtbw.observation} - ${i.ecwtbw.recommendation}</td>
        <td>${i.segmental_lean.insight} - ${i.segmental_lean.observation} - ${i.segmental_lean.recommendation}</td>
        <td>${i.segmental_fat.insight} - ${i.segmental_fat.observation} - ${i.segmental_fat.recommendation}</td>
        <td>${i.overall.insight} - ${i.overall.observation} - ${i.overall.recommendation}</td>
      </tr>`;
    }).join('');
  }

  function renderSegments(s){
    $('lean-la').textContent=segFmt(s.segments_lean.la);
    $('lean-ra').textContent=segFmt(s.segments_lean.ra);
    $('lean-tr').textContent=segFmt(s.segments_lean.tr);
    $('lean-ll').textContent=segFmt(s.segments_lean.ll);
    $('lean-rl').textContent=segFmt(s.segments_lean.rl);
    $('fat-la').textContent=segFmt(s.segments_fat.la);
    $('fat-ra').textContent=segFmt(s.segments_fat.ra);
    $('fat-tr').textContent=segFmt(s.segments_fat.tr);
    $('fat-ll').textContent=segFmt(s.segments_fat.ll);
    $('fat-rl').textContent=segFmt(s.segments_fat.rl);
  }
  function renderIOR(s){
    $('overall-insight').textContent=s.ior.overall.insight||'-';
    $('overall-observation').textContent=s.ior.overall.observation||'-';
    $('overall-reco').textContent=s.ior.overall.recommendation||'-';
    $('ior-composition-insight').textContent=s.ior.composition.insight||'-';
    $('ior-composition-observation').textContent=s.ior.composition.observation||'-';
    $('ior-composition-reco').textContent=s.ior.composition.recommendation||'-';
    $('ior-bmr-insight').textContent=s.ior.bmr_obesity.insight||'-';
    $('ior-bmr-observation').textContent=s.ior.bmr_obesity.observation||'-';
    $('ior-bmr-reco').textContent=s.ior.bmr_obesity.recommendation||'-';
    $('ior-lean-insight').textContent=s.ior.segmental_lean.insight||'-';
    $('ior-lean-observation').textContent=s.ior.segmental_lean.observation||'-';
    $('ior-lean-reco').textContent=s.ior.segmental_lean.recommendation||'-';
    $('ior-fat-insight').textContent=s.ior.segmental_fat.insight||'-';
    $('ior-fat-observation').textContent=s.ior.segmental_fat.observation||'-';
    $('ior-fat-reco').textContent=s.ior.segmental_fat.recommendation||'-';
  }

  // Forecast math (OLS)
  const toDate=d=>new Date(d+'T00:00:00');
  const daysBetween=(a,b)=>Math.round((toDate(b)-toDate(a))/86400000);
  const linReg=(xs,ys)=>{
    const n=xs.length, sx=xs.reduce((a,b)=>a+b,0), sy=ys.reduce((a,b)=>a+b,0);
    const sxx=xs.reduce((a,x)=>a+x*x,0), sxy=xs.reduce((a,_,i)=>a+xs[i]*ys[i],0);
    const b=(n*sxy - sx*sy)/(n*sxx - sx*sx || 1e-6); const a=(sy - b*sx)/n;
    const resid=ys.map((y,i)=>y-(a+b*xs[i])); const std=Math.sqrt(resid.reduce((s,v)=>s+v*v,0)/Math.max(1,n-2));
    return {a,b,std};
  };

  function forecastAll(){
    if(!scans.length) return {fcw:null,fcp:null,fcs:null, table:[]};
    const base=scans[0].date, last=scans[scans.length-1].date;
    const t=scans.map(s=>daysBetween(base,s.date));
    const weight=scans.map(s=>s.metrics.weight);
    const pbf=scans.map(s=>s.metrics.pbf);

    // estimate height from weight/BMI; use median
    const heights=scans.map(s=>Math.sqrt(s.metrics.weight/ s.metrics.bmi));
    const sorted=[...heights].sort((a,b)=>a-b);
    const height=sorted[Math.floor(sorted.length/2)]||1.7;
    const smi=scans.map(s=> s.metrics.smm/(height*height));

    const rw=linReg(t,weight), rp=linReg(t,pbf), rs=linReg(t,smi);
    const offsets=[0,14,28,84];
    const out=offsets.map(off=>{
      const tt=daysBetween(base,last)+off;
      const date=new Date(toDate(last).getTime()+off*86400000).toISOString().slice(0,10);
      const w=rw.a+rw.b*tt, p=Math.min(60,Math.max(8, rp.a+rp.b*tt)), s=rs.a+rs.b*tt;
      return {date, w:+w.toFixed(1), p:+p.toFixed(1), s:+s.toFixed(1), wBand:rw.std.toFixed(1), pBand:rp.std.toFixed(1), sBand:rs.std.toFixed(1)};
    });
    return {height, table:out, lastIndex:scans.length-1};
  }

  function renderForecast(){
    const {table} = forecastAll();
    if(!table.length) return;
    const today=table[0], w2=table[1], w4=table[2], w12=table[3];

    const cur=scans[scans.length-1].metrics;
    const chips=(id,unit,vals,band)=>{
      const del=(v,curv,name)=>{ const d=v-curv, a=Math.abs(d).toFixed(unit==='level'?0:1);
        const good = (name==='Weight'||name==='PBF') ? d<0 : (name==='SMI' ? d>0 : false);
        const cls = d===0?'neutral':(good?'good':'bad'); const arrow=d>0?'▲':d<0?'▼':'•';
        return `<span class="f-chip f-delta ${cls}">${arrow} ${d>0?'+':''}${a} ${unit}</span>`;
      };
      $(id).innerHTML = [
        `<span class="f-chip">2w: ${vals[0]} ${unit}</span>`, del(vals[0],vals[3],vals[4]),
        `<span class="f-chip">4w: ${vals[1]} ${unit}</span>`, del(vals[1],vals[3],vals[4]),
        `<span class="f-chip">12w: ${vals[2]} ${unit}</span>`, del(vals[2],vals[3],vals[4]),
        `<span class="f-chip small">~ +/- ${band} ${unit}</span>`
      ].join(' ');
    };

    // Weight
    chips('fcw-vals','kg',[w2.w, w4.w, w12.w, cur.weight, 'Weight'], today.wBand);
    $('fcw-note').textContent='Assumes current trend continues; no major behavior changes.';

    // SMI (derived)
    // Recompute current SMI from current scan
    const h=(function(){const heights=scans.map(s=>Math.sqrt(s.metrics.weight/ s.metrics.bmi)); const sorted=[...heights].sort((a,b)=>a-b); return sorted[Math.floor(sorted.length/2)]||1.7;})();
    const curSMI=(cur.smm/(h*h)).toFixed(1);
    chips('fcs-vals','kg/m^2',[table[1].s, table[2].s, table[3].s, +curSMI, 'SMI'], table[0].sBand);
    $('fcs-note').textContent='SMI uses estimated height from BMI; median height used for stability.';

    // PBF
    chips('fcp-vals','%',[w2.p, w4.p, w12.p, cur.pbf, 'PBF'], today.pBand);
    $('fcp-note').textContent='Bounded to 8-60%.';

    // Milestones table
    const tb=$('milestones').querySelector('tbody');
    tb.innerHTML = table.map((r,i)=>{
      const dW = (r.w - table[0].w).toFixed(1);
      const dS = (r.s - table[0].s).toFixed(1);
      const dP = (r.p - table[0].p).toFixed(1);
      const delta = i===0 ? '0 (today)' :
        `${dW>0?'+':''}${dW} kg, ${dS>0?'+':''}${dS} SMI, ${dP>0?'+':''}${dP} %`;
      const label = i===0?'Today': i===1?'+2w': i===2?'+4w':'+12w';
      return `<tr><td>${label} - ${r.date}</td><td>${r.w.toFixed(1)}</td><td>${r.s.toFixed(1)}</td><td>${r.p.toFixed(1)}</td><td>${delta}</td></tr>`;
    }).join('');
  }

  // Meal plan
  function mealPlan(){
    const s=scans[scans.length-1];
    const def=deficitFor(s);
    const BMR=s.metrics.bmr, TDEE=BMR*1.35;
    let target=Math.round(TDEE - def.mid);
    target=Math.max(Math.round(BMR)+100, target);
    const weight=s.metrics.weight;

    const protein=Math.ceil(weight*1.6); // g
    const fat=Math.max(Math.round(weight*0.8), 40); // g minimum 40
    const kcalFromPF=protein*4 + fat*9;
    const carbs=Math.max(Math.round((target - kcalFromPF)/4), 60);

    const summary=`Target ~ ${target} kcal/day | P ${protein} g | C ${carbs} g | F ${fat} g (BMR ${Math.round(BMR)}, TDEE ~ ${Math.round(TDEE)}, deficit ${def.range[0]}-${def.range[1]} kcal).`;
    $('meal-summary').textContent=summary;

    const days=[
      {name:'Day 1', meals:[
        'Oats 60 g + whey 30 g + berries',
        'Chicken breast 150 g + rice 150 g + greens',
        'Skyr 200 g + honey 10 g + walnuts 15 g',
        'Salmon 150 g + potatoes 250 g + salad'
      ]},
      {name:'Day 2', meals:[
        'Egg white omelette (4 whites + 1 whole) + toast',
        'Turkey mince 150 g + pasta 120 g + tomato sauce',
        'Greek yogurt 200 g + banana',
        'Beef 150 g + quinoa 120 g + broccoli'
      ]},
      {name:'Day 3', meals:[
        'Smoothie (whey 30 g, banana, oats 40 g)',
        'Tuna 1 can + rice 150 g + veg',
        'Cottage cheese 200 g + crackers',
        'Chicken thighs 180 g + couscous 120 g + salad'
      ]},
      {name:'Day 4', meals:[
        'Overnight oats 60 g + chia 10 g + whey 25 g',
        'Pork loin 150 g + rice 150 g + kimchi',
        'Protein bar ~200 kcal',
        'Shrimp 180 g + noodles 120 g + veg stir-fry'
      ]},
      {name:'Day 5', meals:[
        'Toast x2 + peanut butter 25 g + whey 25 g',
        'Chicken breast 160 g + potatoes 250 g + veg',
        'Skyr 200 g + fruit',
        'White fish 200 g + rice 150 g + salad'
      ]},
      {name:'Day 6', meals:[
        'Eggs 2 + oats 50 g + whey 20 g',
        'Lean beef 150 g + rice 150 g + veg',
        'Yogurt 200 g + granola 30 g',
        'Turkey 160 g + pasta 120 g + marinara'
      ]},
      {name:'Day 7', meals:[
        'Protein pancakes (whey 25 g, oats 50 g) + fruit',
        'Chicken 150 g + sweet potato 250 g + greens',
        'Cottage cheese 200 g + pineapple',
        'Salmon 150 g + rice 130 g + salad'
      ]}
    ];

    const daysEl=$('meal-days');
    daysEl.innerHTML = days.map(d=>{
      return `<div class="day"><h5>${d.name} <span class="badge-kcal">${target} kcal | P ${protein} | C ${carbs} | F ${fat}</span></h5>
      <ul class="small">${d.meals.map(m=>`<li>${m}</li>`).join('')}</ul></div>`;
    }).join('');

    // Grocery list (condensed)
    const list=[
      'Chicken breast/thighs','Turkey mince','Lean beef','Pork loin','Salmon/white fish','Shrimp','Eggs',
      'Whey or protein powder','Skyr/Greek yogurt','Cottage cheese',
      'Rice','Pasta','Potatoes/Sweet potatoes','Noodles','Quinoa','Oats','Bread/Toast',
      'Veg mix (broccoli, greens, salad)','Tomato/marinara sauce','Fruit (banana, berries, pineapple)',
      'Olive oil','Nuts/walnuts','Granola','Honey','Kimchi/spices'
    ];
    $('grocery').innerHTML = list.map(i=>`<div>• ${i}</div>`).join('');
  }

  function applyKPI(idx){
    const s=scans[idx], pi=prevIndex(idx), p=pi>=0?scans[pi]:null;
    $('last-scan').textContent=`Last scan: ${s.label} - ${s.date}`;

    setGauge($('g-weight'),s.metrics.weight,120,fmt(s.metrics.weight,1)); $('m-weight').textContent=fmt(s.metrics.weight,1);
    setGauge($('g-smm'),s.metrics.smm,45,fmt(s.metrics.smm,1)); $('m-smm').textContent=fmt(s.metrics.smm,1);
    setGauge($('g-pbf'),s.metrics.pbf,60,fmt(s.metrics.pbf,1)); $('m-pbf').textContent=fmt(s.metrics.pbf,1);
    setGauge($('g-obesity'),s.metrics.obesity,200,fmt(s.metrics.obesity,1)); $('m-obesity').textContent=fmt(s.metrics.obesity,1);
    setGauge($('g-visc'),s.metrics.visceral,20,String(s.metrics.visceral)); $('m-visc').textContent=String(s.metrics.visceral);
    setGauge($('g-bmr'),s.metrics.bmr,2200,String(Math.round(s.metrics.bmr))); $('m-bmr').textContent=String(Math.round(s.metrics.bmr));
    setGauge($('g-score'),s.metrics.score,100,String(Math.round(s.metrics.score))); $('m-score').textContent=String(Math.round(s.metrics.score));

    const def=deficitFor(s);
    $('badge-deficit').textContent=`${def.mid}`; $('m-deficit').textContent=`${def.mid}`; $('m-deficit-range').textContent=`range ${def.range[0]}-${def.range[1]}`;

    function setDelta(elId, name, unit, cur, prev){
      const res=delta(cur,prev,name,unit,'previous'); const el=$(elId); el.className='delta '+res.cls; el.textContent=res.text;
    }
    if(p){
      setDelta('d-weight','Body Weight','kg',s.metrics.weight,p.metrics.weight);
      setDelta('d-smm','Skeletal Muscle Mass','kg',s.metrics.smm,p.metrics.smm);
      setDelta('d-pbf','Percent Body Fat','%',s.metrics.pbf,p.metrics.pbf);
      setDelta('d-obesity','Obesity Degree','%',s.metrics.obesity,p.metrics.obesity);
      setDelta('d-visc','Visceral Fat Level','level',s.metrics.visceral,p.metrics.visceral);
      setDelta('d-bmr','Basal Metabolic Rate','kcal',s.metrics.bmr,p.metrics.bmr);
      const prevDef=deficitFor(p); const ch=def.mid-prevDef.mid; const arrow=ch>0?'▲':ch<0?'▼':'•'; const sign=ch>0?'+':ch<0?'-':'';
      $('d-deficit').className='delta neutral'; $('d-deficit').textContent=`${arrow} ${sign}${Math.abs(ch)} kcal since previous`;
      const res=delta(s.metrics.score,p.metrics.score,'InBody Score','/ 100','previous'); $('d-score').className='delta '+res.cls; $('d-score').textContent=res.text;
    }else{
      ['d-weight','d-smm','d-pbf','d-obesity','d-visc','d-bmr','d-deficit','d-score'].forEach(id=>{ $(id).className='delta neutral'; $(id).textContent='No previous scan to compare'; });
    }
  }

  function renderCompare(idx){
    const mode=getCompareMode();
    const modeLabel = mode==='baseline' ? 'baseline' : 'previous';
    const s=scans[idx];
    let ref=null;
    if(mode==='baseline'){ ref=scans[baselineIndex]; compareTitle.textContent=`Changes Compared With Baseline (${ref?.label||'-'})`; compareBaselineLabel.textContent=`(${ref?.label||'Baseline'})`; }
    else{ const pi=prevIndex(idx); ref = pi>=0?scans[pi]:null; compareTitle.textContent=`Changes Compared With Previous Scan`; compareBaselineLabel.textContent=''; }
    const cont=$('compare-strip');
    if(!ref){ cont.innerHTML=`<div class="card mini"><h5>Comparison</h5><div class="small">No ${modeLabel} scan to compare</div></div>`; return; }
    if(mode==='baseline' && idx===baselineIndex){ cont.innerHTML=`<div class="card mini"><h5>Comparison</h5><div class="small">No baseline difference (same scan)</div></div>`; return; }
    const items=[
      {name:'Body Weight', unit:'kg', cur:s.metrics.weight, prev:ref.metrics.weight},
      {name:'Percent Body Fat', unit:'%', cur:s.metrics.pbf, prev:ref.metrics.pbf},
      {name:'Fat Mass', unit:'kg', cur:s.metrics.fat, prev:ref.metrics.fat},
      {name:'Skeletal Muscle Mass', unit:'kg', cur:s.metrics.smm, prev:ref.metrics.smm},
      {name:'Body Mass Index', unit:'', cur:s.metrics.bmi, prev:ref.metrics.bmi},
      {name:'Visceral Fat Level', unit:'level', cur:s.metrics.visceral, prev:ref.metrics.visceral},
      {name:'Obesity Degree', unit:'%', cur:s.metrics.obesity, prev:ref.metrics.obesity},
      {name:'Basal Metabolic Rate', unit:'kcal', cur:s.metrics.bmr, prev:ref.metrics.bmr},
      {name:'InBody Score', unit:'/ 100', cur:s.metrics.score, prev:ref.metrics.score},
    ];
    cont.innerHTML = items.map(it=>{
      const d=delta(it.cur,it.prev,it.name,it.unit,modeLabel);
      const decimals=(it.unit==='level'||it.unit==='/ 100')?0:1;
      const prevT=(it.unit==='kcal'||it.unit==='level'||it.unit==='/ 100')?Math.round(it.prev):fmt(it.prev,decimals);
      const curT =(it.unit==='kcal'||it.unit==='level'||it.unit==='/ 100')?Math.round(it.cur):fmt(it.cur,decimals);
      const extraStyle = (mode==='baseline') ? 'style="border-color:rgba(34,211,238,.35);box-shadow:0 0 0 1px rgba(34,211,238,.18) inset"' : '';
      return `<div class="card mini" ${extraStyle}>
        <h5>${it.name}</h5>
        <div class="delta ${d.cls}">${d.text}</div>
        <div class="fromto">${prevT} ${it.unit} → ${curT} ${it.unit}</div>
      </div>`;
    }).join('');
  }

  function renderAll(idx){
    const s=scans[idx];
    applyKPI(idx);
    renderCompare(idx);
    renderIOR(s);
    renderSegments(s);
    renderForecast();
    mealPlan();
    renderDataSource();
  }

  function updateDebug(){
    $('debug').textContent=`- Loaded ${scans.length} scans (source: ${source}) | options: ${sel.options.length}`;
  }

  // Menu overlay (centered + keyboard + scroll lock)
  const menuBtn=$('btn-menu');
  const menu=document.createElement('div');
  menu.className='menu';
  menu.innerHTML=`<div class="inner"><button class="close" id="menu-close">Close</button><div class="content"><h3>Menu</h3><p class="small">Quick links</p><div><span class="pill">Composition</span><span class="pill">Metabolic</span><span class="pill">Segments</span><span class="pill">Repository</span></div></div></div>`;
  document.body.appendChild(menu);
  const closeMenu=()=>{menu.style.display='none';document.body.style.overflow='';};
  const openMenu=()=>{menu.style.display='block';document.body.style.overflow='hidden';$('menu-close')?.focus();};
  menuBtn.addEventListener('click',openMenu);
  menu.addEventListener('click',(e)=>{ if(e.target.id==='menu-close'||e.target===menu) closeMenu(); });
  document.addEventListener('keydown',e=>{ if(menu.style.display==='block' && e.key==='Escape') closeMenu(); });

  // Init
  renderRepo(scans);
  mountSelect(scans);

  // Events
  sel.addEventListener('change',()=>{ renderAll(Number(sel.value)); });
  compareFieldset.addEventListener('change',(e)=>{ if(e.target.name==='compareMode'){ setCompareMode(e.target.value); compareBaselineLabel.textContent = e.target.value==='baseline' ? `(${scans[0]?.label||'Baseline'})` : ''; renderCompare(Number(sel.value)); }});

})();
</script>
</body>
</html>