<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>InBody Tracker</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap" rel="stylesheet">
<style>
:root{
  --bg:#0b0f17; --panel:#0c1322; --panel-2:#0c1526; --text:#e5e7eb; --muted:#9ca3af;
  --border:rgba(255,255,255,0.08);
  --neon-cyan:#22d3ee; --neon-purple:#a78bfa; --neon-amber:#f59e0b; --neon-green:#34d399; --neon-red:#f87171;
  --radius:16px; --shadow:0 10px 30px rgba(0,0,0,.35), 0 0 0 1px var(--border) inset;
}
*{box-sizing:border-box}
html{height:100%;-webkit-text-size-adjust:100%}
body{
  min-height:100%;margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,Helvetica,sans-serif;
  color:var(--text);
  background:
    radial-gradient(1100px 500px at 75% -10%, rgba(167,139,250,.12), transparent 60%),
    radial-gradient(900px 450px at -10% 5%, rgba(34,211,238,.08), transparent 55%),
    linear-gradient(#0b0f17,#0b0f17);
  padding-top:env(safe-area-inset-top); padding-bottom:max(12px,env(safe-area-inset-bottom));
}
.container{max-width:1120px;margin:0 auto;padding:12px 10px 72px}
header.header{display:grid;grid-template-columns:1fr;gap:12px;align-items:center;margin-bottom:12px}
@media(min-width:760px){ header.header{grid-template-columns:1fr auto}}
.brand{
  background:linear-gradient(135deg, rgba(34,211,238,.16), rgba(167,139,250,.16));
  border:1px solid var(--border); border-radius:16px; padding:12px 14px; box-shadow:var(--shadow);
  display:flex;flex-direction:column;gap:6px;min-height:96px
}
.brand h1{margin:0;font-weight:800;letter-spacing:.2px;font-size:1.16rem}
.meta{display:flex;flex-wrap:wrap;gap:8px 12px;color:var(--muted);font-size:.86rem}
.controls{display:flex;gap:10px;align-items:center}
@media(max-width:759.98px){ .controls{width:100%} }
select#scan-select{
  flex:1 1 auto;width:100%;appearance:none;background:linear-gradient(180deg,#0c1424,#0c1528);
  color:var(--text);border:1px solid var(--border);border-radius:12px;padding:12px 40px 12px 12px;font-weight:600;outline:0;box-shadow:var(--shadow)
}
.hamburger{position:relative;width:44px;height:44px;border-radius:12px;border:1px solid var(--border);
  background:linear-gradient(180deg,#0c1420,#0c1426);display:grid;place-items:center;box-shadow:var(--shadow),0 0 18px rgba(34,211,238,.25);cursor:pointer}
.hamburger:hover{transform:translateY(-2px);transition:transform .15s ease, box-shadow .15s ease}
.hamburger::before,.hamburger::after,.hamburger span{content:"";display:block;position:absolute;width:20px;height:2px;background:var(--neon-cyan);border-radius:2px;box-shadow:0 0 10px rgba(34,211,238,.7)}
.hamburger::before{top:14px} .hamburger span{top:21px} .hamburger::after{top:28px}
.menu{position:fixed;inset:0;background:rgba(7,10,17,.88);backdrop-filter:blur(8px);display:none;z-index:60;padding:20px}
.menu.open{display:block}
.menu .inner{max-width:1120px;margin:0 auto}
.menu .close{float:right;color:var(--neon-cyan);text-decoration:underline;cursor:pointer}
.menu .pill{display:inline-block;margin:0 8px 8px 0;padding:10px 14px;border:1px solid var(--border);border-radius:999px;background:linear-gradient(180deg,#0e1526,#0e1629)}

.grid{display:grid;gap:10px}
.card{
  background:linear-gradient(180deg,var(--panel),var(--panel-2));
  border:1px solid var(--border);border-radius:16px;padding:10px;box-shadow:var(--shadow);
  position:relative;overflow:hidden;transform:translateY(6px);opacity:0;animation:fadeUp .5s ease forwards
}
.card:hover{transform:translateY(-2px);box-shadow:var(--shadow),0 0 24px rgba(167,139,250,.15),0 0 0 1px rgba(255,255,255,.04) inset;transition:.16s}
@keyframes fadeUp{to{opacity:1;transform:translateY(0)}}
@media(prefers-reduced-motion:reduce){.card{animation:none;opacity:1;transform:none}.card:hover{transition:none}}

.small{font-size:.86rem;color:var(--muted)}
.section-title{margin:16px 0 8px;font-weight:800;font-size:1.05rem;letter-spacing:.3px}

.kpis{grid-template-columns:1fr 1fr}
@media(min-width:740px){.kpis{grid-template-columns:repeat(4,1fr)}} 
@media(min-width:1024px){.kpis{grid-template-columns:repeat(8,1fr)}}
.kpi{display:grid;grid-template-columns:auto 1fr;gap:10px;align-items:center}
.kpi h4{margin:0 0 4px 0;font-size:.9rem;color:var(--muted);font-weight:600}
.val-big{font-weight:800;font-size:1.02rem}
.unit{font-size:.78rem;color:var(--muted)}
.delta{margin-top:6px;display:inline-flex;align-items:center;gap:6px;font-size:.78rem;padding:4px 8px;border-radius:999px;border:1px solid var(--border);background:#0d1525}
.delta.good{color:#c8f7dc;box-shadow:0 0 0 1px rgba(52,211,153,.25) inset, 0 0 12px rgba(52,211,153,.12)}
.delta.bad{color:#ffd7d7;box-shadow:0 0 0 1px rgba(248,113,113,.25) inset, 0 0 12px rgba(248,113,113,.12)}
.delta.neutral{color:#d1d5db;box-shadow:0 0 0 1px rgba(255,255,255,.12) inset}
.gauge{--size:52px;--track:7px;--val:0;--max:100;--hue:190;width:var(--size);height:var(--size);border-radius:50%;
  background:conic-gradient(hsl(var(--hue),95%,62%) calc(var(--val)/var(--max)*1turn), rgba(255,255,255,.08) 0);display:grid;place-items:center;transition:background .6s ease;box-shadow:inset 0 0 12px rgba(0,0,0,.35),0 0 18px rgba(34,211,238,.15)}
.gauge::after{content:"";width:calc(var(--size) - var(--track)*2);height:calc(var(--size) - var(--track)*2);border-radius:50%;background:linear-gradient(180deg,#0a0f1a,#0b1220);box-shadow: inset 0 0 0 1px var(--border)}
.gval{position:absolute;width:var(--size);text-align:center;font-weight:800;font-size:.9rem;letter-spacing:.2px}
.badge{min-width:48px;min-height:48px;border-radius:50%;display:grid;place-items:center;border:1px solid var(--border);background:linear-gradient(180deg,#0c1424,#0c1528);box-shadow:var(--shadow)}
.kpi-cluster{position:relative}
.kpi-cluster::after{content:"";position:absolute;right:-6px;top:8%;bottom:8%;width:1px;background:linear-gradient(transparent, rgba(255,255,255,.06), transparent);display:none}
@media(min-width:1024px){ .kpi-cluster::after{display:block} }

.charts{display:grid;grid-template-columns:1fr;gap:10px}
@media(min-width:900px){.charts{grid-template-columns:1fr 1fr}}
.chart-card canvas{width:100% !important;height:48vw !important;max-height:320px;min-height:180px;display:block}
@media(min-width:900px){.chart-card canvas{height:280px !important}}
.chart-card h4{margin:0 0 8px 0;font-size:.95rem}

.compare{display:grid;gap:10px}
@media(min-width:560px){.compare{grid-template-columns:repeat(2,1fr)}}
@media(min-width:900px){.compare{grid-template-columns:repeat(3,1fr)}}
@media(min-width:1120px){.compare{grid-template-columns:repeat(4,1fr)}}
.mini{padding:10px}
.mini h5{margin:0 0 6px 0;font-size:.9rem;color:var(--muted)}
.mini .delta{margin:0 0 6px 0}
.mini .fromto{font-size:.82rem;color:var(--muted)}

.segments{display:grid;gap:10px}
@media(min-width:900px){.segments{grid-template-columns:1fr 1fr}}
.sil-body{position:relative;min-height:260px;display:grid;place-items:center}
.human{width:150px;height:230px;opacity:.9;filter:drop-shadow(0 0 16px rgba(167,139,250,.12))}
.box{position:absolute;min-width:110px;padding:8px 10px;border:1px solid var(--border);border-radius:12px;background:linear-gradient(180deg,#0c1424,#0d1528);box-shadow:var(--shadow);font-size:.86rem}
.box .name{color:var(--muted);font-size:.78rem} .box .val{font-weight:800}
.la{left:-10px;top:60px} .ra{right:-10px;top:60px} .tr{left:50%;transform:translateX(-50%);top:10px} .ll{left:-10px;bottom:26px} .rl{right:-10px;bottom:26px}

.ior-table{width:100%;border-collapse:collapse;font-size:.9rem}
.ior-table th,.ior-table td{padding:10px;border-top:1px solid var(--border);border-bottom:1px solid var(--border);text-align:left;vertical-align:top}
.ior-table th{color:var(--muted);font-weight:600;width:140px}
.big-ior h4{margin:0 0 8px 0}

details.repo{padding:12px} details.repo summary{cursor:pointer;list-style:none;font-weight:800}
.table-wrap{overflow:auto;margin-top:10px;border-top:1px solid var(--border)}
table.master{width:max(100%,960px);border-collapse:collapse;font-size:.9rem}
table.master th,table.master td{border-bottom:1px solid var(--border);padding:8px 10px;text-align:left;vertical-align:top}
table.master th{position:sticky;top:0;background:#0d1424;z-index:1}
@media(max-width:420px){
  .brand h1{font-size:1.05rem}.val-big{font-size:.98rem}.unit{font-size:.74rem}
  .gauge{--size:48px;--track:6px}.badge{min-width:44px;min-height:44px}
}
</style>
</head>
<body>
<div class="container">

  <!-- Header -->
  <header class="header">
    <div class="brand">
      <h1>InBody Tracker</h1>
      <div class="meta">
        <div id="last-scan">Last scan: -</div>
        <div class="small" id="debug">- Loaded 0 scans (source: -) | options: 0</div>
      </div>
    </div>
    <div class="controls">
      <select id="scan-select" aria-label="Select scan"></select>
      <button class="hamburger" id="btn-menu" aria-label="Open menu"><span aria-hidden="true"></span></button>
    </div>
  </header>

  <!-- KPI Row (8 cards by similarity) -->
  <section class="grid kpis" id="kpi-row">
    <!-- Cluster A: Composition -->
    <div class="kpi-cluster card">
      <div class="kpi">
        <div class="gauge" id="g-weight" style="--hue:190"><div class="gval" id="gv-weight">-</div></div>
        <div>
          <h4>Body Weight</h4>
          <div class="val-big" id="m-weight">-</div>
          <div class="unit">kg</div>
          <div class="delta neutral" id="d-weight">No previous scan to compare</div>
        </div>
      </div>
    </div>
    <div class="kpi-cluster card">
      <div class="kpi">
        <div class="gauge" id="g-smm" style="--hue:160; --max:45"><div class="gval" id="gv-smm">-</div></div>
        <div>
          <h4>Skeletal Muscle Mass</h4>
          <div class="val-big" id="m-smm">-</div>
          <div class="unit">kg</div>
          <div class="delta neutral" id="d-smm">No previous scan to compare</div>
        </div>
      </div>
    </div>

    <!-- Cluster B: Adiposity -->
    <div class="kpi-cluster card">
      <div class="kpi">
        <div class="gauge" id="g-pbf" style="--hue:270; --max:60"><div class="gval" id="gv-pbf">-</div></div>
        <div>
          <h4>Percent Body Fat</h4>
          <div class="val-big" id="m-pbf">-</div>
          <div class="unit">%</div>
          <div class="delta neutral" id="d-pbf">No previous scan to compare</div>
        </div>
      </div>
    </div>
    <div class="kpi-cluster card">
      <div class="kpi">
        <div class="gauge" id="g-obesity" style="--hue:12; --max:200"><div class="gval" id="gv-obesity">-</div></div>
        <div>
          <h4>Obesity Degree</h4>
          <div class="val-big" id="m-obesity">-</div>
          <div class="unit">%</div>
          <div class="delta neutral" id="d-obesity">No previous scan to compare</div>
        </div>
      </div>
    </div>
    <div class="kpi-cluster card">
      <div class="kpi">
        <div class="gauge" id="g-visc" style="--hue:8; --max:20"><div class="gval" id="gv-visc">-</div></div>
        <div>
          <h4>Visceral Fat Level</h4>
          <div class="val-big" id="m-visc">-</div>
          <div class="unit">level</div>
          <div class="delta neutral" id="d-visc">No previous scan to compare</div>
        </div>
      </div>
    </div>

    <!-- Cluster C: Metabolic -->
    <div class="kpi-cluster card">
      <div class="kpi">
        <div class="gauge" id="g-bmr" style="--hue:42; --max:2200"><div class="gval" id="gv-bmr">-</div></div>
        <div>
          <h4>Basal Metabolic Rate</h4>
          <div class="val-big" id="m-bmr">-</div>
          <div class="unit">kcal</div>
          <div class="delta neutral" id="d-bmr">No previous scan to compare</div>
        </div>
      </div>
    </div>
    <div class="kpi-cluster card">
      <div class="kpi">
        <div class="badge" id="badge-deficit"></div>
        <div>
          <h4>Calorie Deficit Target</h4>
          <div class="val-big" id="m-deficit">-</div>
          <div class="unit" id="m-deficit-range">range -</div>
          <div class="delta neutral" id="d-deficit">No previous scan to compare</div>
        </div>
      </div>
    </div>

    <!-- Cluster D: Overall -->
    <div class="kpi-cluster card">
      <div class="kpi">
        <div class="gauge" id="g-score" style="--hue:150; --max:100"><div class="gval" id="gv-score">-</div></div>
        <div>
          <h4>InBody Score</h4>
          <div class="val-big" id="m-score">-</div>
          <div class="unit">/ 100</div>
          <div class="delta neutral" id="d-score">No previous scan to compare</div>
        </div>
      </div>
    </div>
  </section>

  <!-- Comparison Mini-Cards -->
  <h3 class="section-title">Changes Compared With Previous Scan</h3>
  <section class="compare" id="compare-strip"></section>

  <!-- Overall I-O-R -->
  <section class="card big-ior" style="margin-top:10px">
    <h4>🤖 Overall Insight - Observation - Recommendation</h4>
    <p><strong>Insight:</strong> <span id="overall-insight">-</span></p>
    <p><strong>Observation:</strong> <span id="overall-observation">-</span></p>
    <p><strong>Recommendation:</strong> <span id="overall-reco">-</span></p>
  </section>

  <!-- Panel 1 -->
  <h3 class="section-title">Composition + BMI/PBF</h3>
  <section class="charts">
    <div class="card chart-card">
      <h4>Body Weight, Skeletal Muscle Mass, Fat Mass (time series)</h4>
      <canvas id="chart-comp"></canvas>
    </div>
    <div class="card chart-card">
      <h4>Body Mass Index vs Percent Body Fat (scatter)</h4>
      <canvas id="chart-bmi"></canvas>
    </div>
  </section>
  <section class="card">
    <h4>🤖 I-O-R</h4>
    <table class="ior-table">
      <tr><th>Insight</th><td id="ior-composition-insight">-</td></tr>
      <tr><th>Observation</th><td id="ior-composition-observation">-</td></tr>
      <tr><th>Recommendation</th><td id="ior-composition-reco">-</td></tr>
    </table>
  </section>

  <!-- Panel 2 -->
  <h3 class="section-title">Metabolic & Fluids</h3>
  <section class="charts">
    <div class="card chart-card">
      <h4>Basal Metabolic Rate (kcal) + Obesity Degree (%)</h4>
      <canvas id="chart-bmr"></canvas>
    </div>
    <div class="card chart-card">
      <h4>ECW/TBW (range 0.36 - 0.40)</h4>
      <canvas id="chart-ecw"></canvas>
    </div>
  </section>
  <section class="card">
    <h4>🤖 I-O-R</h4>
    <table class="ior-table">
      <tr><th>Insight</th><td id="ior-bmr-insight">-</td></tr>
      <tr><th>Observation</th><td id="ior-bmr-observation">-</td></tr>
      <tr><th>Recommendation</th><td id="ior-bmr-reco">-</td></tr>
    </table>
  </section>

  <!-- Panel 3 -->
  <h3 class="section-title">Segmental Analysis</h3>
  <section class="segments">
    <div class="card">
      <h4>Segmental Lean (Muscle)</h4>
      <div class="sil-body">
        <svg class="human" viewBox="0 0 120 180" aria-hidden="true">
          <defs><linearGradient id="grad" x1="0" y1="0" x2="0" y2="1"><stop offset="0%" stop-color="#1b2538"/><stop offset="100%" stop-color="#0f1726"/></linearGradient></defs>
          <g fill="url(#grad)" stroke="rgba(255,255,255,0.06)" stroke-width="1">
            <ellipse cx="60" cy="20" rx="16" ry="16"/><rect x="44" y="36" width="32" height="46" rx="10"/>
            <rect x="22" y="42" width="18" height="42" rx="9"/><rect x="80" y="42" width="18" height="42" rx="9"/>
            <rect x="40" y="84" width="16" height="70" rx="8"/><rect x="64" y="84" width="16" height="70" rx="8"/>
          </g>
        </svg>
        <div class="box la"><div class="name">LA</div><div class="val" id="lean-la">-</div></div>
        <div class="box ra"><div class="name">RA</div><div class="val" id="lean-ra">-</div></div>
        <div class="box tr"><div class="name">Trunk</div><div class="val" id="lean-tr">-</div></div>
        <div class="box ll"><div class="name">LL</div><div class="val" id="lean-ll">-</div></div>
        <div class="box rl"><div class="name">RL</div><div class="val" id="lean-rl">-</div></div>
      </div>
      <section class="card" style="margin-top:10px">
        <h4>🤖 I-O-R</h4>
        <table class="ior-table">
          <tr><th>Insight</th><td id="ior-lean-insight">-</td></tr>
          <tr><th>Observation</th><td id="ior-lean-observation">-</td></tr>
          <tr><th>Recommendation</th><td id="ior-lean-reco">-</td></tr>
        </table>
      </section>
    </div>

    <div class="card">
      <h4>Segmental Fat (Fat)</h4>
      <div class="sil-body">
        <svg class="human" viewBox="0 0 120 180" aria-hidden="true">
          <defs><linearGradient id="grad2" x1="0" y1="0" x2="0" y2="1"><stop offset="0%" stop-color="#1b2538"/><stop offset="100%" stop-color="#0f1726"/></linearGradient></defs>
          <g fill="url(#grad2)" stroke="rgba(255,255,255,0.06)" stroke-width="1">
            <ellipse cx="60" cy="20" rx="16" ry="16"/><rect x="44" y="36" width="32" height="46" rx="10"/>
            <rect x="22" y="42" width="18" height="42" rx="9"/><rect x="80" y="42" width="18" height="42" rx="9"/>
            <rect x="40" y="84" width="16" height="70" rx="8"/><rect x="64" y="84" width="16" height="70" rx="8"/>
          </g>
        </svg>
        <div class="box la"><div class="name">LA</div><div class="val" id="fat-la">-</div></div>
        <div class="box ra"><div class="name">RA</div><div class="val" id="fat-ra">-</div></div>
        <div class="box tr"><div class="name">Trunk</div><div class="val" id="fat-tr">-</div></div>
        <div class="box ll"><div class="name">LL</div><div class="val" id="fat-ll">-</div></div>
        <div class="box rl"><div class="name">RL</div><div class="val" id="fat-rl">-</div></div>
      </div>
      <section class="card" style="margin-top:10px">
        <h4>🤖 I-O-R</h4>
        <table class="ior-table">
          <tr><th>Insight</th><td id="ior-fat-insight">-</td></tr>
          <tr><th>Observation</th><td id="ior-fat-observation">-</td></tr>
          <tr><th>Recommendation</th><td id="ior-fat-reco">-</td></tr>
        </table>
      </section>
    </div>
  </section>

  <!-- Repository -->
  <details class="repo" style="margin-top:12px">
    <summary>Data Repository (master table)</summary>
    <div class="table-wrap">
      <table class="master" id="repo-table">
        <thead>
          <tr>
            <th>Date</th><th>Label</th>
            <th>Weight</th><th>Percent Body Fat</th><th>Body Mass Index</th><th>InBody Score</th>
            <th>Visceral Fat Level</th><th>Skeletal Muscle Mass</th><th>Fat Mass</th><th>Basal Metabolic Rate</th>
            <th>Total Body Water</th><th>Protein</th><th>Minerals</th><th>Fat-Free Mass</th><th>Obesity Degree</th><th>ECW/TBW</th>
            <th>I-O-R composition</th><th>I-O-R bmi_pbf</th><th>I-O-R bmr_obesity</th><th>I-O-R ecwtbw</th>
            <th>I-O-R segmental_lean</th><th>I-O-R segmental_fat</th><th>I-O-R overall</th>
          </tr>
        </thead>
        <tbody id="repo-body"></tbody>
      </table>
    </div>
  </details>

  <!-- Data Source (BOTTOM) -->
  <section class="card" id="data-source" style="margin-top:12px">
    <h3 style="margin:0 0 8px 0;font-size:.98rem">Data Source</h3>
    <div class="grid" style="grid-template-columns:1fr;gap:8px">
      <div class="card" style="padding:8px">
        <table class="ds-table" style="width:100%;border-collapse:collapse;font-size:.9rem">
          <tbody>
            <tr><th style="text-align:left;color:var(--muted);width:160px;padding:8px 10px;border-bottom:1px solid var(--border)">Source</th><td id="ds-source" style="padding:8px 10px;border-bottom:1px solid var(--border)">-</td></tr>
            <tr><th style="text-align:left;color:var(--muted);padding:8px 10px;border-bottom:1px solid var(--border)">Loaded</th><td id="ds-loaded" style="padding:8px 10px;border-bottom:1px solid var(--border)">-</td></tr>
            <tr><th style="text-align:left;color:var(--muted);padding:8px 10px;border-bottom:1px solid var(--border)">Records</th><td id="ds-records" style="padding:8px 10px;border-bottom:1px solid var(--border)">-</td></tr>
            <tr><th style="text-align:left;color:var(--muted);padding:8px 10px;border-bottom:1px solid var(--border)">Latest Label</th><td id="ds-latest-label" style="padding:8px 10px;border-bottom:1px solid var(--border)">-</td></tr>
            <tr><th style="text-align:left;color:var(--muted);padding:8px 10px;border-bottom:1px solid var(--border)">Latest Date</th><td id="ds-latest-date" style="padding:8px 10px;border-bottom:1px solid var(--border)">-</td></tr>
            <tr><th style="text-align:left;color:var(--muted);padding:8px 10px;border-bottom:1px solid var(--border)">Notes</th><td id="ds-notes" style="padding:8px 10px;border-bottom:1px solid var(--border)">-</td></tr>
          </tbody>
        </table>
        <div class="small" id="ds-debug" style="margin-top:6px">-</div>
      </div>
      <div class="card" style="padding:8px">
        <details>
          <summary style="cursor:pointer;font-weight:700">Raw Data (JSON)</summary>
          <pre id="raw-json" style="max-height:300px;overflow:auto;margin:8px 0 0;border:1px solid var(--border);border-radius:8px;padding:8px;background:#0a0f1a;color:#dfe3ea;font-size:.82rem"></pre>
        </details>
      </div>
    </div>
  </section>

</div>

<!-- Embedded JSON -->
<script type="application/json" id="scans-json">{"scans":[{"date":"2025-03-01","label":"Mar 2025 (est.)","metrics":{"weight":90.0,"pbf":42.0,"bmi":31.9,"score":62,"visceral":15,"smm":32.0,"fat":38.0,"bmr":1750,"tbw":42.5,"protein":11.2,"minerals":3.8,"ffm":52.0,"obesity":145.0,"ecwtbw":0.390},"segments_lean":{"la":{"kg":3.00,"pct":98.0},"ra":{"kg":3.10,"pct":98.5},"tr":{"kg":21.0,"pct":99.0},"ll":{"kg":9.40,"pct":97.5},"rl":{"kg":9.50,"pct":98.0}},"segments_fat":{"la":{"kg":3.04,"pct":8.0},"ra":{"kg":3.04,"pct":8.0},"tr":{"kg":19.0,"pct":50.0},"ll":{"kg":6.46,"pct":17.0},"rl":{"kg":6.46,"pct":17.0}},"ior":{"composition":{"insight":"Fat dominant","observation":"High fat, lower muscle relative","recommendation":"Deficit + protein >= 1.6 g/kg"},"bmi_pbf":{"insight":"BMI and PBF high","observation":"BMI 31.9, PBF 42%","recommendation":"Add waist/hip tracking"},"bmr_obesity":{"insight":"BMR high due to mass","observation":"1750 kcal baseline","recommendation":"Moderate deficit 300-500"},"ecwtbw":{"insight":"Hydration high side","observation":"ECW/TBW 0.390","recommendation":"Control sodium"},"segmental_lean":{"insight":"Balanced limbs, trunk heavy","observation":"~97-99% of standard","recommendation":"Balanced training"},"segmental_fat":{"insight":"Central fat heavy (est)","observation":"Trunk 50% share","recommendation":"Prioritize trunk fat loss"},"overall":{"insight":"Obese baseline","observation":"VF 15, obesity 145%","recommendation":"Initiate fat-loss"}}},{"date":"2025-04-15","label":"Mid-Apr 2025 (est.)","metrics":{"weight":84.7,"pbf":39.6,"bmi":30.0,"score":63,"visceral":14,"smm":31.2,"fat":33.5,"bmr":1700,"tbw":41.0,"protein":10.9,"minerals":3.7,"ffm":51.2,"obesity":139.0,"ecwtbw":0.389},"segments_lean":{"la":{"kg":2.90,"pct":97.8},"ra":{"kg":3.00,"pct":98.2},"tr":{"kg":20.5,"pct":98.5},"ll":{"kg":9.20,"pct":97.2},"rl":{"kg":9.30,"pct":97.6}},"segments_fat":{"la":{"kg":2.68,"pct":8.0},"ra":{"kg":2.68,"pct":8.0},"tr":{"kg":16.75,"pct":50.0},"ll":{"kg":5.70,"pct":17.0},"rl":{"kg":5.70,"pct":17.0}},"ior":{"composition":{"insight":"Early fat drop","observation":"~5 kg fat loss","recommendation":"Add resistance training"},"bmi_pbf":{"insight":"PBF down faster than BMI","observation":"PBF 39.6, BMI 30.0","recommendation":"Loss <= 0.7% BW/week"},"bmr_obesity":{"insight":"BMR slightly down","observation":"1700 kcal","recommendation":"Avoid aggressive cuts"},"ecwtbw":{"insight":"Hydration stable","observation":"0.389","recommendation":"35-40 ml/kg"},"segmental_lean":{"insight":"Balanced limbs","observation":"Arms 98%, legs 97%","recommendation":"Add squats/deadlifts"},"segmental_fat":{"insight":"Fat down modest","observation":"VF down 1","recommendation":"2-3 cardio/week"},"overall":{"insight":"Good start","observation":"-5.3 kg total","recommendation":"Sustain momentum"}}},{"date":"2025-06-13","label":"13 Jun 2025 (scan)","metrics":{"weight":80.6,"pbf":32.6,"bmi":28.6,"score":65,"visceral":12,"smm":30.4,"fat":26.2,"bmr":1544,"tbw":39.9,"protein":10.7,"minerals":3.75,"ffm":54.4,"obesity":130.0,"ecwtbw":0.388},"segments_lean":{"la":{"kg":3.05,"pct":95.7},"ra":{"kg":3.12,"pct":97.9},"tr":{"kg":24.8,"pct":97.6},"ll":{"kg":8.09,"pct":91.3},"rl":{"kg":8.16,"pct":92.0}},"segments_fat":{"la":{"kg":1.90,"pct":333.8},"ra":{"kg":1.90,"pct":323.6},"tr":{"kg":14.10,"pct":358.4},"ll":{"kg":3.50,"pct":223.9},"rl":{"kg":3.60,"pct":225.8}},"ior":{"composition":{"insight":"Strong fat loss","observation":"Fat -11.8, SMM -1.6","recommendation":"Keep deficit; carbs pre-workout"},"bmi_pbf":{"insight":"PBF dropping faster","observation":"BMI 28.6, PBF 32.6%","recommendation":"Use tape and photos"},"bmr_obesity":{"insight":"BMR stable","observation":"1544 kcal","recommendation":"Deficit 300-500 kcal"},"ecwtbw":{"insight":"Hydration healthy","observation":"0.388","recommendation":"Maintain electrolytes"},"segmental_lean":{"insight":"Legs weak","observation":"LL 91%, RL 92%","recommendation":"Unilateral work"},"segmental_fat":{"insight":"Central fat high","observation":"Trunk 14.1 kg (358%)","recommendation":"Aerobic + core stability"},"overall":{"insight":"Overfat improving","observation":"VF 12","recommendation":"Push to VF < 10"}}},{"date":"2025-09-11","label":"11 Sep 2025 (scan)","metrics":{"weight":79.0,"pbf":31.3,"bmi":28.0,"score":66,"visceral":10,"smm":30.4,"fat":24.8,"bmr":1542,"tbw":39.8,"protein":10.6,"minerals":3.75,"ffm":54.2,"obesity":127.9,"ecwtbw":0.388},"segments_lean":{"la":{"kg":3.00,"pct":94.6},"ra":{"kg":3.03,"pct":95.6},"tr":{"kg":24.4,"pct":96.6},"ll":{"kg":8.15,"pct":92.6},"rl":{"kg":8.19,"pct":92.9}},"segments_fat":{"la":{"kg":1.70,"pct":303.4},"ra":{"kg":1.70,"pct":298.3},"tr":{"kg":13.20,"pct":334.8},"ll":{"kg":3.50,"pct":217.6},"rl":{"kg":3.50,"pct":218.5}},"ior":{"composition":{"insight":"Progress steady","observation":"Muscle stable, fat down","recommendation":"Lift 2-3x/week"},"bmi_pbf":{"insight":"PBF steady drop","observation":"BMI 28.0, PBF 31.3%","recommendation":"~0.5% BW loss/week"},"bmr_obesity":{"insight":"BMR stable","observation":"1542 kcal","recommendation":"Avoid further drop"},"ecwtbw":{"insight":"Hydration steady","observation":"0.388","recommendation":"~3 L/day"},"segmental_lean":{"insight":"Arms/trunk solid, legs lag","observation":"Legs ~92%","recommendation":"Leg hypertrophy focus"},"segmental_fat":{"insight":"Central fat dropping","observation":"VF 10","recommendation":"Add HIIT block"},"overall":{"insight":"Near overweight","observation":"VF 10","recommendation":"Push to VF <= 9"}}},{"date":"2025-09-24","label":"24 Sep 2025 (scan)","metrics":{"weight":76.8,"pbf":29.7,"bmi":27.2,"score":68,"visceral":9,"smm":30.2,"fat":22.8,"bmr":1536,"tbw":39.6,"protein":10.6,"minerals":3.75,"ffm":54.0,"obesity":124.8,"ecwtbw":0.387},"segments_lean":{"la":{"kg":3.01,"pct":96.6},"ra":{"kg":3.08,"pct":98.2},"tr":{"kg":24.4,"pct":97.4},"ll":{"kg":7.87,"pct":90.9},"rl":{"kg":7.94,"pct":90.9}},"segments_fat":{"la":{"kg":1.50,"pct":274.2},"ra":{"kg":1.50,"pct":271.7},"tr":{"kg":12.30,"pct":314.1},"ll":{"kg":3.10,"pct":192.5},"rl":{"kg":3.10,"pct":194.0}},"ior":{"composition":{"insight":"Milestone","observation":"Fat -15.2, muscle stable","recommendation":"Start recomposition"},"bmi_pbf":{"insight":"BMI vs PBF gap","observation":"BMI 27.2, PBF 29.7%","recommendation":"Aim PBF <= 25%"},"bmr_obesity":{"insight":"BMR stable","observation":"1536 kcal","recommendation":"Preserve strength"},"ecwtbw":{"insight":"Hydration optimal","observation":"0.387","recommendation":"Maintain intake"},"segmental_lean":{"insight":"Legs lag","observation":"~91%","recommendation":"Lower-body overload"},"segmental_fat":{"insight":"Abdominal fat down","observation":"VF 9","recommendation":"Transition to recomp + diet breaks"},"overall":{"insight":"Obese to overweight","observation":"-13.2 kg; ~85% fat loss; VF 9","recommendation":"Next: 72 kg, PBF <= 25%, VF <= 7"}}}]}</script>

<!-- Chart.js multi-CDN loader -->
<script>
function ensureChartJs(init){
  if(window.Chart){ window.__chartReady__=true; init(); return; }
  const urls=[
    "https://cdn.jsdelivr.net/npm/chart.js@4.4.4/dist/chart.umd.min.js?v=1",
    "https://unpkg.com/chart.js@4.4.4/dist/chart.umd.js?v=1",
    "https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.4/chart.umd.min.js?v=1"
  ];
  (function next(){
    const url=urls.shift(); if(!url){ window.__chartReady__=false; init(); return; }
    const s=document.createElement('script'); s.src=url;
    s.onload=()=>{ window.__chartReady__=true; init(); };
    s.onerror=()=>next();
    document.head.appendChild(s);
  })();
}
</script>

<script>
(function(){
  'use strict';
  const byId=id=>document.getElementById(id);
  const sel=byId('scan-select');

  // Parse JSON or fallback
  const jsonText = byId('scans-json')?.textContent || '{}';
  let scans = [];
  let dataSource = 'json';
  try{
    const parsed = JSON.parse(jsonText);
    scans = Array.isArray(parsed.scans) ? parsed.scans : [];
    if(!scans.length) throw new Error('empty');
  }catch(_){
    dataSource = 'fallback';
    try { scans = JSON.parse(jsonText).scans || []; } catch(e){ scans = []; }
  }

  // helpers
  const fmt=(v,d=1)=> (v==null||Number.isNaN(v))?'-':Number(v).toFixed(d);
  const setGauge=(el,val,max,text)=>{ if(!el) return; el.style.setProperty('--val',Number(val||0)); el.style.setProperty('--max',Number(max||100)); const gv=el.querySelector('.gval'); if(gv) gv.textContent=text??fmt(val, (max<=100?1:0)); };
  const segFmt = o => `${(o?.kg==null)?'-':fmt(o.kg,2)+' kg'} | ${(o?.pct==null)?'-':fmt(o.pct,1)+' %'}`;

  function mountSelect(items){
    const html = items.map((s,i)=>`<option value="${i}">${s.label} - ${s.date}</option>`).join('');
    sel.innerHTML = html; // one assignment (iOS-safe)
    sel.selectedIndex = items.length - 1;
    updateDebug();
    renderAll(sel.selectedIndex);
  }
  function previousIndex(i){ return i>0 ? i-1 : -1; }
  function parseRangeFromText(t){
    const m = (t||'').match(/(\d+)\s*-\s*(\d+)/);
    if(m){ let a=+m[1], b=+m[2]; if(a>b){ const x=a;a=b;b=x; } return [a,b]; }
    return null;
  }
  function clamp(v,min,max){ return Math.min(max, Math.max(min,v)); }
  function round10(v){ return Math.round(v/10)*10; }
  function computeDeficit(scan){
    const rec = scan?.ior?.bmr_obesity?.recommendation || '';
    let range = parseRangeFromText(rec);
    if(!range){
      const bmr = Number(scan?.metrics?.bmr||0);
      const tdee = bmr * 1.35;
      let lo = round10(tdee*0.15), hi = round10(tdee*0.20);
      lo = clamp(lo,250,750); hi = clamp(hi,250,750); if(hi<lo){ const t=lo;lo=hi;hi=t; }
      range = [lo,hi];
    }
    const mid = round10((range[0]+range[1])/2);
    return {range, mid};
  }

  const goodWhenDown = new Set(["Body Weight","Percent Body Fat","Visceral Fat Level","Obesity Degree","Fat Mass"]);
  const goodWhenUp   = new Set(["Skeletal Muscle Mass","Basal Metabolic Rate","InBody Score"]);
  function delta(curr, prev, name, unit){
    if(prev==null) return {text:"No previous scan to compare", cls:"neutral", zero:true};
    const diff = Number(curr) - Number(prev);
    const abs = Math.abs(diff);
    const arrow = diff>0 ? "▲" : diff<0 ? "▼" : "•";
    const sign = diff>0 ? "+" : diff<0 ? "-" : "";
    const decimals = (unit==="/ 100"||unit==="level") ? 0 : 1;
    const text = `${arrow} ${sign}${abs.toFixed(decimals)} ${unit} since previous`;
    let cls="neutral";
    if(diff===0) cls="neutral";
    else if( (diff<0 && goodWhenDown.has(name)) || (diff>0 && goodWhenUp.has(name)) ) cls="good";
    else cls="bad";
    return {text, cls};
  }

  function renderDataSource(){
    const latest = scans[scans.length-1] || {};
    byId('ds-source').textContent = (dataSource==='json')? 'Embedded JSON (scans-json)' : 'Fallback Array';
    byId('ds-loaded').textContent = scans.length? 'Yes':'No';
    byId('ds-records').textContent = String(scans.length);
    byId('ds-latest-label').textContent = latest.label || '-';
    byId('ds-latest-date').textContent = latest.date || '-';
    byId('ds-notes').textContent = (window.__chartReady__ ? 'Chart.js loaded' : 'Chart.js not loaded');
    const dbg = `- Loaded ${scans.length} scans (source: ${dataSource}) | options: ${sel.options.length}`;
    byId('ds-debug').textContent = dbg;
    byId('debug').textContent = dbg;
    try{ byId('raw-json').textContent = JSON.stringify({scans}, null, 2); }catch(_){}
  }

  function renderRepo(items){
    const tbody = byId('repo-body'); let rows='';
    for(const s of items){
      const m=s.metrics, i=s.ior;
      rows += `<tr>
        <td>${s.date}</td><td>${s.label}</td>
        <td>${fmt(m.weight,1)}</td><td>${fmt(m.pbf,1)}</td><td>${fmt(m.bmi,1)}</td><td>${fmt(m.score,0)}</td>
        <td>${m.visceral}</td><td>${fmt(m.smm,1)}</td><td>${fmt(m.fat,1)}</td><td>${Math.round(m.bmr)}</td>
        <td>${fmt(m.tbw,1)}</td><td>${fmt(m.protein,1)}</td><td>${fmt(m.minerals,2)}</td><td>${fmt(m.ffm,1)}</td>
        <td>${fmt(m.obesity,1)}</td><td>${fmt(m.ecwtbw,3)}</td>
        <td>${i.composition.insight} - ${i.composition.observation} - ${i.composition.recommendation}</td>
        <td>${i.bmi_pbf.insight} - ${i.bmi_pbf.observation} - ${i.bmi_pbf.recommendation}</td>
        <td>${i.bmr_obesity.insight} - ${i.bmr_obesity.observation} - ${i.bmr_obesity.recommendation}</td>
        <td>${i.ecwtbw.insight} - ${i.ecwtbw.observation} - ${i.ecwtbw.recommendation}</td>
        <td>${i.segmental_lean.insight} - ${i.segmental_lean.observation} - ${i.segmental_lean.recommendation}</td>
        <td>${i.segmental_fat.insight} - ${i.segmental_fat.observation} - ${i.segmental_fat.recommendation}</td>
        <td>${i.overall.insight} - ${i.overall.observation} - ${i.overall.recommendation}</td>
      </tr>`;
    }
    tbody.innerHTML = rows;
  }

  function renderSegments(s){
    byId('lean-la').textContent = segFmt(s.segments_lean.la);
    byId('lean-ra').textContent = segFmt(s.segments_lean.ra);
    byId('lean-tr').textContent = segFmt(s.segments_lean.tr);
    byId('lean-ll').textContent = segFmt(s.segments_lean.ll);
    byId('lean-rl').textContent = segFmt(s.segments_lean.rl);
    byId('fat-la').textContent = segFmt(s.segments_fat.la);
    byId('fat-ra').textContent = segFmt(s.segments_fat.ra);
    byId('fat-tr').textContent = segFmt(s.segments_fat.tr);
    byId('fat-ll').textContent = segFmt(s.segments_fat.ll);
    byId('fat-rl').textContent = segFmt(s.segments_fat.rl);
  }

  function renderIOR(s){
    byId('overall-insight').textContent = s.ior.overall.insight || '-';
    byId('overall-observation').textContent = s.ior.overall.observation || '-';
    byId('overall-reco').textContent = s.ior.overall.recommendation || '-';

    byId('ior-composition-insight').textContent = s.ior.composition.insight || '-';
    byId('ior-composition-observation').textContent = s.ior.composition.observation || '-';
    byId('ior-composition-reco').textContent = s.ior.composition.recommendation || '-';

    byId('ior-bmr-insight').textContent = s.ior.bmr_obesity.insight || '-';
    byId('ior-bmr-observation').textContent = s.ior.bmr_obesity.observation || '-';
    byId('ior-bmr-reco').textContent = s.ior.bmr_obesity.recommendation || '-';

    byId('ior-lean-insight').textContent = s.ior.segmental_lean.insight || '-';
    byId('ior-lean-observation').textContent = s.ior.segmental_lean.observation || '-';
    byId('ior-lean-reco').textContent = s.ior.segmental_lean.recommendation || '-';
    byId('ior-fat-insight').textContent = s.ior.segmental_fat.insight || '-';
    byId('ior-fat-observation').textContent = s.ior.segmental_fat.observation || '-';
    byId('ior-fat-reco').textContent = s.ior.segmental_fat.recommendation || '-';
  }

  // Charts
  let chComp, chBMI, chBMR, chECW;
  const destroy = c => { try{ c && c.destroy && c.destroy(); }catch(_){ } };
  function commonOptions(){
    return {responsive:true,maintainAspectRatio:false,interaction:{intersect:false,mode:'nearest'},
      layout:{padding:{left:4,right:8,top:4,bottom:2}},
      plugins:{legend:{labels:{color:'#d1d5db',boxWidth:12,font:{size:11}}},tooltip:{bodyFont:{size:11},titleFont:{size:11}}},
      scales:{x:{ticks:{color:'#9ca3af',font:{size:10}},grid:{color:'rgba(255,255,255,.06)'}},
              y:{ticks:{color:'#9ca3af',font:{size:10}},grid:{color:'rgba(255,255,255,.06)'}}}
    };
  }
  function renderCharts(items){
    if(!window.__chartReady__){
      ['chart-comp','chart-bmi','chart-bmr','chart-ecw'].forEach(id=>{
        const cv=byId(id); if(cv && !cv.dataset.note){ const note=document.createElement('div'); note.style.color='var(--muted)'; note.style.fontSize='.85rem'; note.style.marginTop='8px'; note.textContent='Chart.js not loaded. Data is still available in cards and table.'; cv.parentElement.appendChild(note); cv.dataset.note='1'; }
      });
      return;
    }
    const labels=items.map(s=>s.label), w=items.map(s=>s.metrics.weight), smm=items.map(s=>s.metrics.smm),
          fat=items.map(s=>s.metrics.fat), bmi=items.map(s=>s.metrics.bmi), pbf=items.map(s=>s.metrics.pbf),
          bmr=items.map(s=>s.metrics.bmr), ob=items.map(s=>s.metrics.obesity), ecw=items.map(s=>s.metrics.ecwtbw);

    destroy(chComp);
    chComp = new Chart(byId('chart-comp'),{type:'line',data:{labels,datasets:[
      {label:'Body Weight',data:w,tension:.3, borderColor:'#22d3ee', pointRadius:2},
      {label:'Skeletal Muscle Mass',data:smm,tension:.3,borderColor:'#34d399', pointRadius:2},
      {label:'Fat Mass',data:fat,tension:.3,borderColor:'#f59e0b', pointRadius:2}]},options:commonOptions()});

    destroy(chBMI);
    chBMI = new Chart(byId('chart-bmi'),{type:'scatter',data:{datasets:[
      {label:'BMI vs Percent Body Fat', data:bmi.map((x,i)=>({x, y:pbf[i]})), borderColor:'#a78bfa', backgroundColor:'#a78bfa', pointRadius:4}]},
      options:(()=>{const o=commonOptions();o.scales.x.title={display:true,text:'Body Mass Index',color:'#9ca3af'};o.scales.y.title={display:true,text:'Percent Body Fat',color:'#9ca3af'};return o;})()});

    destroy(chBMR);
    chBMR = new Chart(byId('chart-bmr'),{type:'line',data:{labels,datasets:[
      {label:'Basal Metabolic Rate',data:bmr,yAxisID:'y',tension:.3,borderColor:'#22d3ee',pointRadius:2},
      {label:'Obesity Degree %',data:ob,yAxisID:'y1',tension:.3,borderColor:'#f87171',pointRadius:2}]},
      options:(()=>{const o=commonOptions();o.scales.y.position='left';o.scales.y1={position:'right',ticks:{color:'#9ca3af'},grid:{drawOnChartArea:false}};return o;})()});

    destroy(chECW);
    chECW = new Chart(byId('chart-ecw'),{type:'line',data:{labels,datasets:[
      {label:'ECW/TBW',data:ecw,tension:.3,borderColor:'#34d399',pointRadius:2}]},
      options:(()=>{const o=commonOptions();o.scales.y.min=0.36;o.scales.y.max=0.40;o.scales.y.ticks.stepSize=0.01;return o;})()});
  }

  function applyKPI(index){
    const s = scans[index], prevI = previousIndex(index), p = prevI>=0 ? scans[prevI] : null;
    byId('last-scan').textContent = `Last scan: ${s.label} - ${s.date}`;

    setGauge(byId('g-weight'), s.metrics.weight, 120, fmt(s.metrics.weight,1)); byId('m-weight').textContent = fmt(s.metrics.weight,1);
    setGauge(byId('g-smm'), s.metrics.smm, 45, fmt(s.metrics.smm,1)); byId('m-smm').textContent = fmt(s.metrics.smm,1);
    setGauge(byId('g-pbf'), s.metrics.pbf, 60, fmt(s.metrics.pbf,1)); byId('m-pbf').textContent = fmt(s.metrics.pbf,1);
    setGauge(byId('g-obesity'), s.metrics.obesity, 200, fmt(s.metrics.obesity,1)); byId('m-obesity').textContent = fmt(s.metrics.obesity,1);
    setGauge(byId('g-visc'), s.metrics.visceral, 20, String(s.metrics.visceral)); byId('m-visc').textContent = String(s.metrics.visceral);
    setGauge(byId('g-bmr'), s.metrics.bmr, 2200, String(Math.round(s.metrics.bmr))); byId('m-bmr').textContent = String(Math.round(s.metrics.bmr));
    setGauge(byId('g-score'), s.metrics.score, 100, String(Math.round(s.metrics.score))); byId('m-score').textContent = String(Math.round(s.metrics.score));

    const def = computeDeficit(s);
    byId('badge-deficit').textContent = `${def.mid}`;
    byId('m-deficit').textContent = `${def.mid}`;
    byId('m-deficit-range').textContent = `range ${def.range[0]}-${def.range[1]}`;

    const d = (name, unit, curr, prev)=>{ const res = delta(curr, prev, name, unit); const el=byId('d-'+name.toLowerCase().replaceAll(' ','').replaceAll('/100','score')); el.className='delta '+res.cls; el.textContent=res.text; };
    if(p){
      d('Body Weight','kg',s.metrics.weight,p.metrics.weight);
      d('Skeletal Muscle Mass','kg',s.metrics.smm,p.metrics.smm);
      d('Percent Body Fat','%',s.metrics.pbf,p.metrics.pbf);
      d('Obesity Degree','%',s.metrics.obesity,p.metrics.obesity);
      d('Visceral Fat Level','level',s.metrics.visceral,p.metrics.visceral);
      d('Basal Metabolic Rate','kcal',s.metrics.bmr,p.metrics.bmr);
      const prevDef = computeDeficit(p);
      const el=byId('d-deficit'); el.className='delta neutral';
      const change = def.mid - prevDef.mid; const arrow = change>0?'▲':change<0?'▼':'•'; const sign = change>0?'+':change<0?'-':''; el.textContent = `${arrow} ${sign}${Math.abs(change)} kcal since previous`;
      d('InBody Score','/ 100',s.metrics.score,p.metrics.score);
    }else{
      ['weight','smm','pbf','obesity','visc','bmr','deficit','score'].forEach(k=>{ const el=byId('d-'+k); el.className='delta neutral'; el.textContent='No previous scan to compare'; });
    }
  }

  function renderCompare(index){
    const s=scans[index], prevI=previousIndex(index), p=prevI>=0?scans[prevI]:null;
    const cont = byId('compare-strip');
    if(!p){ cont.innerHTML = `<div class="card mini"><h5>Comparison</h5><div class="small">No previous scan to compare</div></div>`; return; }
    const items=[
      {name:'Body Weight', unit:'kg', cur:s.metrics.weight, prev:p.metrics.weight},
      {name:'Percent Body Fat', unit:'%', cur:s.metrics.pbf, prev:p.metrics.pbf},
      {name:'Fat Mass', unit:'kg', cur:s.metrics.fat, prev:p.metrics.fat},
      {name:'Skeletal Muscle Mass', unit:'kg', cur:s.metrics.smm, prev:p.metrics.smm},
      {name:'Body Mass Index', unit:'', cur:s.metrics.bmi, prev:p.metrics.bmi},
      {name:'Visceral Fat Level', unit:'level', cur:s.metrics.visceral, prev:p.metrics.visceral},
      {name:'Obesity Degree', unit:'%', cur:s.metrics.obesity, prev:p.metrics.obesity},
      {name:'Basal Metabolic Rate', unit:'kcal', cur:s.metrics.bmr, prev:p.metrics.bmr},
      {name:'InBody Score', unit:'/ 100', cur:s.metrics.score, prev:p.metrics.score},
    ];
    cont.innerHTML = items.map(it=>{
      const dd = delta(it.cur,it.prev,it.name,it.unit||'');
      const prevT = (it.unit==='kcal'||it.unit==='level'||it.unit==='/ 100')? Math.round(it.prev) : fmt(it.prev,1);
      const curT  = (it.unit==='kcal'||it.unit==='level'||it.unit==='/ 100')? Math.round(it.cur)  : fmt(it.cur,1);
      return `<div class="card mini">
        <h5>${it.name}</h5>
        <div class="delta ${dd.cls}">${dd.text}</div>
        <div class="fromto">${prevT} ${it.unit} → ${curT} ${it.unit}</div>
      </div>`;
    }).join('');
  }

  function renderAll(index){
    const s=scans[index];
    applyKPI(index);
    renderCompare(index);
    renderIOR(s);
    renderSegments(s);
    renderCharts(scans);
    renderDataSource();
  }

  function updateDebug(){
    byId('debug').textContent = `- Loaded ${scans.length} scans (source: ${dataSource}) | options: ${sel.options.length}`;
  }

  // Menu
  const menuBtn=byId('btn-menu'); const menu=document.createElement('div'); menu.className='menu';
  menu.innerHTML=`<div class="inner"><span class="close" id="menu-close">Close</span><h3>Menu</h3>
  <p class="small">Quick links</p><span class="pill">Composition</span><span class="pill">Metabolic</span><span class="pill">Segments</span><span class="pill">Repository</span></div>`;
  document.body.appendChild(menu);
  menuBtn.addEventListener('click',()=>menu.classList.add('open'));
  menu.addEventListener('click',(e)=>{ if(e.target.id==='menu-close'||e.target===menu) menu.classList.remove('open'); });

  // Init with multi-CDN loader that re-runs after load
  ensureChartJs(function(){
    renderRepo(scans);
    mountSelect(scans);
    if(window.__chartReady__){
      renderCharts(scans);
      renderDataSource();
    }
  });

  sel.addEventListener('change',()=>renderAll(Number(sel.value)));

})();
</script>
</body>
</html>